<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå—å†œä¸šå¤§å­¦æ ¡å›­åœ°å›¾</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿æŒä¸å˜ï¼Œå¢åŠ æ–°çš„æ§åˆ¶æŒ‰é’®æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            font-size: 14px;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100vw;
        }

        header {
            background-color: #1b5e20;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo h1 {
            font-size: 1.6rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .logo-icon {
            font-size: 1.8rem;
            color: #ffcc00;
        }

        .subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 3px;
        }

        .header-info {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            z-index: 500;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-toggle {
            position: absolute;
            top: 70px;
            left: 320px;
            background-color: #1b5e20;
            color: white;
            border: none;
            width: 25px;
            height: 35px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 501;
            transition: left 0.3s ease;
        }

        .sidebar.hidden + .sidebar-toggle {
            left: 0;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box h3, .filter-section h3, .results-list h3, .tools-section h3 {
            margin-bottom: 12px;
            color: #1b5e20;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }

        .search-box h3 i, .filter-section h3 i, .results-list h3 i, .tools-section h3 i {
            color: #388e3c;
        }

        .search-container {
            position: relative;
        }

        #search-input {
            width: 100%;
            padding: 10px 12px;
            padding-left: 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            transition: border 0.3s;
        }

        #search-input:focus {
            outline: none;
            border-color: #388e3c;
            box-shadow: 0 0 0 2px rgba(56, 142, 60, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-btn {
            padding: 6px 12px;
            background-color: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .category-btn:hover {
            background-color: #e8f5e9;
        }

        .category-btn.active {
            background-color: #388e3c;
            color: white;
            border-color: #2e7d32;
        }

        .category-btn i {
            font-size: 0.75rem;
        }

        .results-list {
            margin-top: 15px;
        }

        .building-item {
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
        }

        .building-item:hover {
            border-color: #388e3c;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .building-item.active {
            border-color: #388e3c;
            background-color: #f1f8e9;
        }

        .building-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .building-name {
            font-weight: 600;
            color: #1b5e20;
            font-size: 1rem;
        }

        .building-category {
            font-size: 0.75rem;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .building-description {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* æ”¹è¿›çš„åœ°å›¾æ§åˆ¶æŒ‰é’® - å¸¦æ–‡å­— */
        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            min-width: 100px;
        }

        .control-btn {
            background-color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            font-size: 0.85rem;
            color: #333;
        }

        .control-btn:hover {
            background-color: #f1f8e9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .control-btn .control-icon {
            font-size: 1.1rem;
            margin-right: 8px;
            width: 20px;
            text-align: center;
        }

        .control-btn.zoom-in .control-icon {
            color: #388e3c;
        }

        .control-btn.zoom-out .control-icon {
            color: #f44336;
        }

        .control-btn.reset-view .control-icon {
            color: #2196F3;
        }

        .control-btn.toggle-legend .control-icon {
            color: #9C27B0;
        }

        .control-btn.toggle-navigation .control-icon {
            color: #FF9800;
        }

        .control-btn.toggle-measure .control-icon {
            color: #795548;
        }

        .control-btn.locate-me .control-icon {
            color: #2196F3;
        }

        /* å®šä½æŒ‰é’®ç‰¹æ®Šæ ·å¼ */
        .locate-btn {
            background-color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            width: 100%;
            font-size: 0.85rem;
            color: #333;
        }

        .locate-btn:hover {
            background-color: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .locate-btn.active {
            background-color: #2196F3;
            color: white;
        }

        .locate-btn .control-icon {
            font-size: 1.1rem;
            margin-right: 8px;
            width: 20px;
            text-align: center;
            color: #2196F3;
        }

        .locate-btn.active .control-icon {
            color: white;
        }

        .legend {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background-color: white;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            z-index: 400;
            width: 200px;
        }

        .legend h4 {
            margin-bottom: 10px;
            color: #1b5e20;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .building-detail {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background-color: white;
            padding: 0;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 400;
            width: 320px;
            max-height: 70vh;
            overflow: hidden;
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .building-detail.active {
            transform: translateY(0);
            opacity: 1;
        }

        .detail-header {
            background-color: #1b5e20;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .detail-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-detail {
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-detail:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .detail-content {
            padding: 15px;
            overflow-y: auto;
            max-height: calc(70vh - 60px);
        }

        .detail-row {
            margin-bottom: 12px;
        }

        .detail-label {
            font-weight: 600;
            color: #555;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .detail-value {
            color: #333;
            font-size: 0.9rem;
        }

        .detail-category {
            display: inline-block;
            padding: 4px 10px;
            background-color: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .footer {
            background-color: #1b5e20;
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 0.85rem;
        }

        /* æµ‹é‡å·¥å…·æ ·å¼ */
        .tools-section {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .tool-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tool-btn {
            padding: 8px 12px;
            background-color: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-btn:hover {
            background-color: #e8f5e9;
        }

        .tool-btn.active {
            background-color: #388e3c;
            color: white;
            border-color: #2e7d32;
        }

        .measure-results {
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 6px;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-top: 10px;
            display: none;
        }

        .measure-results.active {
            display: block;
        }

        .measure-point {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .measure-total {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #ddd;
            font-weight: 600;
            color: #1b5e20;
            display: flex;
            justify-content: space-between;
        }

        /* è·¯å¾„è§„åˆ’é¢æ¿æ ·å¼ - å¯æ‹–åŠ¨ */
        .navigation-panel {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: white;
            width: 320px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 400;
            transform: translateX(0);
            opacity: 1;
            display: none;
            cursor: move;
        }

        .navigation-panel.active {
            display: block;
        }

        .navigation-header {
            background-color: #1b5e20;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 6px 6px 0 0;
            cursor: move;
        }

        .navigation-header h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .close-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .navigation-content {
            padding: 15px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .route-inputs {
            margin-bottom: 15px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: white;
            cursor: pointer;
        }

        .input-group select:focus {
            outline: none;
            border-color: #388e3c;
        }

        .route-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .primary-btn, .secondary-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .primary-btn {
            background-color: #388e3c;
            color: white;
        }

        .primary-btn:hover {
            background-color: #2e7d32;
        }

        .secondary-btn {
            background-color: #f5f5f5;
            color: #555;
            border: 1px solid #ddd;
        }

        .secondary-btn:hover {
            background-color: #eee;
        }

        /* æ”¹è¿›çš„è·¯çº¿ç»“æœæ ·å¼ */
        .route-results {
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
        }

        .route-summary {
            background-color: #e8f5e9;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .route-summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        .route-summary-row:last-child {
            margin-bottom: 0;
        }

        .summary-label {
            font-weight: 600;
            color: #1b5e20;
        }

        .summary-value {
            color: #333;
        }

        .route-steps {
            border-top: 1px solid #eee;
            padding-top: 10px;
        }

        .route-step {
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 5px;
            border-left: 4px solid #388e3c;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .step-number {
            background-color: #388e3c;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .step-distance {
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
        }

        .step-instruction {
            font-size: 0.85rem;
            line-height: 1.4;
            color: #444;
        }

        .step-details {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
            padding-left: 10px;
        }

        .route-no-results {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        /* è·¯çº¿å¯¼èˆªæ§åˆ¶æŒ‰é’® */
        .route-navigation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .nav-btn {
            padding: 8px 16px;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background-color: #2e7d32;
        }

        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .nav-btn.prev {
            background-color: #607d8b;
        }

        .nav-btn.prev:hover {
            background-color: #546e7a;
        }

        .nav-btn.next {
            background-color: #388e3c;
        }

        .nav-btn.next:hover {
            background-color: #2e7d32;
        }

        .current-step-indicator {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin: 10px 0;
        }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: absolute;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .context-menu ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
            min-width: 160px;
        }

        .context-menu li {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .context-menu li:hover {
            background-color: #f5f5f5;
        }

        .context-menu .divider {
            height: 1px;
            background-color: #eee;
            margin: 5px 0;
            padding: 0;
        }

        /* åœ°å›¾ç±»å‹é€‰æ‹©å™¨ */
        .map-type-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 5px;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }

        .map-type-btn {
            padding: 6px 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .map-type-btn:hover {
            background-color: #f1f8e9;
        }

        .map-type-btn.active {
            background-color: #388e3c;
            color: white;
            border-color: #2e7d32;
        }

        /* çªå‡ºæ ‡ç­¾æ ·å¼ */
        .highlight-label {
            position: absolute;
            background-color: #FF5722;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 450;
            display: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            white-space: nowrap;
        }

        .highlight-label::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #FF5722;
        }

        /* ================== æµ‹é‡æ§åˆ¶é¢æ¿æ ·å¼ - æ”¹è¿›ç‰ˆ ================== */
        .measure-controls {
            position: absolute;
            top: 150px; /* è°ƒæ•´ä½ç½®ï¼Œé¿å…è¢«é®æŒ¡ */
            left: 15px;
            z-index: 400;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            min-width: 180px;
            cursor: move;
        }

        .measure-controls.active {
            display: flex;
        }

        .measure-controls-header {
            background-color: #795548;
            color: white;
            padding: 10px 12px;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: move;
        }

        .measure-controls-body {
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .measure-control-btn {
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-align: left;
        }

        .measure-control-btn:hover {
            background-color: #f1f8e9;
            transform: translateY(-1px);
        }

        /* åœ°å›¾é”å®šæŒ‰é’®æ ·å¼ */
        .lock-btn {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            z-index: 400;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .lock-btn:hover {
            background-color: #f1f8e9;
            transform: translateX(-50%) scale(1.05);
        }

        .lock-btn.active {
            background-color: #388e3c;
            color: white;
        }

        .lock-btn.active:hover {
            background-color: #2e7d32;
        }

        /* ================== å®šä½åŠŸèƒ½æ ·å¼ ================== */
        /* å®šä½ä¿¡æ¯é¢æ¿ */
        .location-panel {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 12px 15px;
            border-radius: 6px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 400;
            display: none;
            max-width: 400px;
            width: 90%;
        }

        .location-panel.active {
            display: block;
        }

        .location-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .location-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #1b5e20;
        }

        .location-close-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 1.1rem;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .location-close-btn:hover {
            background-color: #f5f5f5;
        }

        .location-content {
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .location-info {
            margin-bottom: 10px;
        }

        .location-coordinates {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .location-accuracy {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 12px;
        }

        .location-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .location-action-btn {
            flex: 1;
            padding: 8px 12px;
            background-color: #f1f8e9;
            border: 1px solid #c5e1a5;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .location-action-btn:hover {
            background-color: #e8f5e9;
        }

        .location-action-btn.primary {
            background-color: #2196F3;
            color: white;
            border-color: #1976D2;
        }

        .location-action-btn.primary:hover {
            background-color: #1976D2;
        }

        /* å®šä½åŠ è½½æŒ‡ç¤ºå™¨ */
        .location-loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.9rem;
        }

        .location-loading.active {
            display: block;
        }

        /* å®šä½é”™è¯¯æç¤º */
        .location-error {
            display: none;
            text-align: center;
            padding: 10px;
            color: #d32f2f;
            font-size: 0.9rem;
            background-color: #ffebee;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .location-error.active {
            display: block;
        }

        /* åœ°å›¾é”å®šçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .map-lock-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1rem;
            display: none;
            z-index: 450;
            text-align: center;
            max-width: 80%;
        }

        .map-lock-indicator.active {
            display: block;
            animation: fadeInOut 2s ease-in-out;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .sidebar {
                width: 300px;
            }
            
            .sidebar.hidden + .sidebar-toggle {
                left: 0;
            }
            
            .sidebar-toggle {
                left: 300px;
            }
            
            .navigation-panel {
                left: 15px;
                right: 15px;
                width: auto;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                width: 100%;
                max-width: 400px;
            }
            
            .sidebar-toggle {
                display: none;
            }
            
            .legend, .map-type-controls, .measure-controls {
                display: none;
            }
            
            .building-detail {
                width: 95%;
                right: 2.5%;
            }
            
            .navigation-panel {
                width: 95%;
                left: 2.5%;
                right: 2.5%;
            }
            
            .map-controls {
                right: 10px;
                top: 10px;
            }
            
            .control-group {
                padding: 5px;
            }
            
            .control-btn {
                width: auto;
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .control-btn .control-icon {
                margin-right: 6px;
                font-size: 1rem;
            }
            
            .measure-controls {
                top: 120px;
                left: 10px;
            }
        }
        
        /* è·¯çº¿è§„åˆ’åŠ è½½æç¤º */
        .route-loading {
            display: none;
            text-align: center;
            padding: 10px;
            color: #666;
            font-size: 0.9rem;
        }
        
        .route-loading.active {
            display: block;
        }
        
        .route-error {
            display: none;
            text-align: center;
            padding: 10px;
            color: #d32f2f;
            font-size: 0.9rem;
            background-color: #ffebee;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .route-error.active {
            display: block;
        }
        
        /* è·¯çº¿æ¨¡å¼æŒ‡ç¤ºå™¨ */
        .mode-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 8px;
        }
        
        .mode-walking {
            background-color: #4CAF50;
            color: white;
        }
        
        .mode-driving {
            background-color: #2196F3;
            color: white;
        }
    </style>
    
    <!-- ç™¾åº¦åœ°å›¾API -->
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=bHbYmLEhs5ydYI1qLqIGiO1G3oSo0Vc8"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <div>
                    <h1>åå—å†œä¸šå¤§å­¦æ ¡å›­åœ°å›¾</h1>
                    <div class="subtitle">South China Agricultural University Campus Map</div>
                </div>
            </div>
            <div class="header-info">
                <span id="building-count">38</span>ä¸ªåœ°ç‚¹ | å¹¿å·Â·å¤©æ²³
            </div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div class="search-box">
                    <h3>æœç´¢æ ¡å›­åœ°ç‚¹</h3>
                    <div class="search-container">
                        <div class="search-icon">ğŸ”</div>
                        <input type="text" id="search-input" placeholder="è¾“å…¥å»ºç­‘åç§°æˆ–æè¿°...">
                    </div>
                </div>

                <div class="filter-section">
                    <h3>æŒ‰ç±»åˆ«ç­›é€‰</h3>
                    <div class="category-list" id="category-filter">
                        <!-- ç±»åˆ«æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="results-list">
                    <h3>æ ¡å›­åœ°ç‚¹åˆ—è¡¨</h3>
                    <div id="buildings-list">
                        <!-- å»ºç­‘åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- æµ‹é‡å·¥å…·éƒ¨åˆ† -->
                <div class="tools-section">
                    <h3>æµ‹é‡å·¥å…·</h3>
                    <div class="tool-controls">
                        <button class="tool-btn" id="measure-distance-btn" title="æµ‹é‡è·ç¦»">
                            ğŸ“ æµ‹é‡è·ç¦»
                        </button>
                        <button class="tool-btn" id="measure-area-btn" title="æµ‹é‡é¢ç§¯">
                            ğŸ“ æµ‹é‡é¢ç§¯
                        </button>
                        <button class="tool-btn" id="clear-measure-btn" title="æ¸…é™¤æµ‹é‡" style="display: none;">
                            ğŸ—‘ï¸ æ¸…é™¤æµ‹é‡
                        </button>
                    </div>
                    <div id="measure-results" class="measure-results">
                        <!-- æµ‹é‡ç»“æœå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <button class="sidebar-toggle" id="sidebar-toggle">
                <span id="toggle-icon">â—€</span>
            </button>

            <div class="map-container">
                <div id="map"></div>
                
                <!-- çªå‡ºæ ‡ç­¾ -->
                <div class="highlight-label" id="highlight-label"></div>
                
                <!-- åœ°å›¾é”å®šæç¤º -->
                <div class="map-lock-indicator" id="map-lock-indicator">
                    åœ°å›¾å·²é”å®š<br>
                    <small>æµ‹é‡æœŸé—´åœ°å›¾ä¸å¯æ‹–åŠ¨</small>
                </div>
                
                <!-- æµ‹é‡æ§åˆ¶é¢æ¿ - æ”¹è¿›ç‰ˆï¼Œå¯æ‹–åŠ¨ -->
                <div class="measure-controls" id="measure-controls">
                    <div class="measure-controls-header">
                        <span>æµ‹é‡æ§åˆ¶</span>
                        <button class="location-close-btn" id="close-measure-controls" style="color: white; font-size: 0.9rem;">
                            âœ•
                        </button>
                    </div>
                    <div class="measure-controls-body">
                        <button class="measure-control-btn" id="finish-measure-btn">
                            âœ… å®Œæˆæµ‹é‡
                        </button>
                        <button class="measure-control-btn" id="cancel-measure-btn">
                            âŒ å–æ¶ˆæµ‹é‡
                        </button>
                        <button class="measure-control-btn" id="undo-last-point-btn">
                            â†©ï¸ æ’¤é”€ä¸Šä¸€ä¸ªç‚¹
                        </button>
                    </div>
                </div>
                
                <!-- åœ°å›¾é”å®šæŒ‰é’® -->
                <div class="lock-btn" id="lock-map-btn">
                    ğŸ”’ é”å®šåœ°å›¾
                </div>
                
                <!-- æ”¹è¿›çš„åœ°å›¾æ§åˆ¶æŒ‰é’® - å¸¦æ–‡å­— -->
                <div class="map-controls">
                    <div class="control-group">
                        <button class="control-btn zoom-in" id="zoom-in" title="æ”¾å¤§">
                            <span class="control-icon">â•</span>
                            <span class="control-text">æ”¾å¤§</span>
                        </button>
                        <button class="control-btn zoom-out" id="zoom-out" title="ç¼©å°">
                            <span class="control-icon">â–</span>
                            <span class="control-text">ç¼©å°</span>
                        </button>
                        <button class="control-btn reset-view" id="reset-view" title="é‡ç½®è§†å›¾">
                            <span class="control-icon">ğŸ </span>
                            <span class="control-text">é‡ç½®</span>
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <button class="control-btn toggle-legend" id="toggle-legend" title="æ˜¾ç¤º/éšè—å›¾ä¾‹">
                            <span class="control-icon">ğŸ—ºï¸</span>
                            <span class="control-text">å›¾ä¾‹</span>
                        </button>
                        <button class="control-btn toggle-navigation" id="toggle-navigation" title="è·¯å¾„è§„åˆ’">
                            <span class="control-icon">ğŸš—</span>
                            <span class="control-text">è·¯å¾„</span>
                        </button>
                        <button class="control-btn toggle-measure" id="toggle-measure" title="æµ‹é‡å·¥å…·">
                            <span class="control-icon">ğŸ“</span>
                            <span class="control-text">æµ‹é‡</span>
                        </button>
                        <!-- æ”¹è¿›çš„å®šä½æŒ‰é’® - å¸¦æ–‡å­— -->
                        <button class="control-btn locate-me" id="locate-me-btn" title="å®šä½æˆ‘çš„ä½ç½®">
                            <span class="control-icon">ğŸ“</span>
                            <span class="control-text">å®šä½</span>
                        </button>
                    </div>
                </div>

                <!-- å›¾ä¾‹ -->
                <div class="legend" id="legend">
                    <h4>å›¾ä¾‹è¯´æ˜</h4>
                    <!-- å›¾ä¾‹å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- å»ºç­‘è¯¦æƒ…é¢æ¿ -->
                <div class="building-detail" id="building-detail">
                    <!-- å»ºç­‘è¯¦æƒ…å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- è·¯å¾„è§„åˆ’é¢æ¿ -->
                <div class="navigation-panel" id="navigation-panel">
                    <div class="navigation-header">
                        <h3>è·¯å¾„è§„åˆ’</h3>
                        <button class="close-btn" id="close-navigation">
                            âœ•
                        </button>
                    </div>
                    <div class="navigation-content">
                        <div class="route-loading" id="route-loading">
                            <div>æ­£åœ¨åŠ è½½è·¯çº¿è§„åˆ’åŠŸèƒ½...</div>
                        </div>
                        <div class="route-error" id="route-error">
                            <!-- é”™è¯¯ä¿¡æ¯å°†åŠ¨æ€æ˜¾ç¤º -->
                        </div>
                        <div class="route-inputs">
                            <div class="input-group">
                                <label>èµ·ç‚¹</label>
                                <select id="route-start">
                                    <option value="">è¯·é€‰æ‹©èµ·ç‚¹...</option>
                                    <!-- æ–°å¢ï¼šå½“å‰ä½ç½®é€‰é¡¹ -->
                                    <option value="current_location" id="current-location-start">ğŸ“ æˆ‘çš„ä½ç½®</option>
                                    <!-- å»ºç­‘é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label>ç»ˆç‚¹</label>
                                <select id="route-end">
                                    <option value="">è¯·é€‰æ‹©ç»ˆç‚¹...</option>
                                    <!-- æ–°å¢ï¼šå½“å‰ä½ç½®é€‰é¡¹ -->
                                    <option value="current_location" id="current-location-end">ğŸ“ æˆ‘çš„ä½ç½®</option>
                                    <!-- å»ºç­‘é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label>å‡ºè¡Œæ–¹å¼</label>
                                <select id="route-mode">
                                    <option value="walking">æ­¥è¡Œ</option>
                                    <option value="driving">é©¾è½¦</option>
                                </select>
                            </div>
                            <div class="route-buttons">
                                <button id="plan-route-btn" class="primary-btn">
                                    ğŸ—ºï¸ è§„åˆ’è·¯çº¿
                                </button>
                                <button id="clear-route-btn" class="secondary-btn">
                                    ğŸ—‘ï¸ æ¸…é™¤è·¯çº¿
                                </button>
                            </div>
                        </div>
                        <div id="route-results" class="route-results">
                            <div class="route-no-results">
                                è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œç„¶åç‚¹å‡»"è§„åˆ’è·¯çº¿"æŒ‰é’®
                            </div>
                        </div>
                        <!-- è·¯çº¿å¯¼èˆªæ§åˆ¶æŒ‰é’® -->
                        <div class="route-navigation-controls" id="route-navigation-controls" style="display: none;">
                            <button class="nav-btn prev" id="prev-step-btn">
                                â—€ ä¸Šä¸€æ­¥
                            </button>
                            <div class="current-step-indicator" id="current-step-indicator">
                                æ­¥éª¤ 0 / 0
                            </div>
                            <button class="nav-btn next" id="next-step-btn">
                                ä¸‹ä¸€æ­¥ â–¶
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- åœ°å›¾ç±»å‹é€‰æ‹© -->
                <div class="map-type-controls">
                    <div class="map-type-btn active" data-type="normal">
                        ğŸ—ºï¸ æ™®é€šåœ°å›¾
                    </div>
                    <div class="map-type-btn" data-type="satellite">
                        ğŸ›°ï¸ å«æ˜Ÿåœ°å›¾
                    </div>
                    <div class="map-type-btn" data-type="hybrid">
                        ğŸŒ æ··åˆåœ°å›¾
                    </div>
                </div>
                
                <!-- æ–°å¢ï¼šå®šä½ä¿¡æ¯é¢æ¿ -->
                <div class="location-panel" id="location-panel">
                    <div class="location-header">
                        <h3>ä½ç½®ä¿¡æ¯</h3>
                        <button class="location-close-btn" id="close-location-panel">
                            âœ•
                        </button>
                    </div>
                    <div class="location-content">
                        <div class="location-loading" id="location-loading">
                            æ­£åœ¨è·å–æ‚¨çš„ä½ç½®...
                        </div>
                        <div class="location-error" id="location-error">
                            <!-- é”™è¯¯ä¿¡æ¯å°†åŠ¨æ€æ˜¾ç¤º -->
                        </div>
                        <div class="location-info" id="location-info" style="display: none;">
                            <div class="location-coordinates">
                                <span>çº¬åº¦: <span id="location-lat">--</span></span>
                                <span>ç»åº¦: <span id="location-lng">--</span></span>
                            </div>
                            <div class="location-accuracy" id="location-accuracy">
                                ç²¾åº¦: æ­£åœ¨è®¡ç®—...
                            </div>
                            <div class="location-actions">
                                <button class="location-action-btn" id="center-on-location">
                                    ğŸ—ºï¸ å±…ä¸­åœ°å›¾
                                </button>
                                <button class="location-action-btn primary" id="set-as-start-from-location">
                                    ğŸš© è®¾ä¸ºèµ·ç‚¹
                                </button>
                                <button class="location-action-btn primary" id="set-as-end-from-location">
                                    ğŸ è®¾ä¸ºç»ˆç‚¹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2023 åå—å†œä¸šå¤§å­¦æ ¡å›­åœ°å›¾ç³»ç»Ÿ | æ•°æ®æ¥æºäºå­¦æ ¡å…¬å¼€ä¿¡æ¯ | åœ°å›¾æœåŠ¡ç”±ç™¾åº¦åœ°å›¾æä¾›</p>
        </div>
    </div>

    <script>
        // å»ºç­‘æ•°æ®ï¼ˆä¿æŒä¸å˜ï¼‰
        const buildingsData = [
            {
                "id": 1,
                "name": "è¥¿å—é—¨",
                "lng": 113.358352,
                "lat": 23.15888,
                "category": "æ ¡é—¨",
                "description": "ä½äºæ ¡å›­è¥¿å—æ–¹å‘çš„ä¸»å…¥å£ä¹‹ä¸€ï¼Œç´§é‚»äº”å±±åœ°é“ç«™ä¸ç”Ÿæ´»åŒºï¼Œäº¤é€šä¾¿åˆ©ï¼Œå¸¸ä¸ºå­¦ç”Ÿæ—¥å¸¸è¿›å‡ºé€šé“ã€‚",
                "color": "#4CAF50"
            },
            {
                "id": 2,
                "name": "è¥¿é—¨",
                "lng": 113.352862,
                "lat": 23.16892,
                "category": "æ ¡é—¨",
                "description": "æ ¡å›­è¥¿ä¾§ä¸»è¦å‡ºå…¥å£ï¼Œé‚»è¿‘å®¿èˆåŒºä¸è¿åŠ¨åœºï¼Œå‘¨è¾¹è®¾æœ‰å…¬äº¤ç«™ç‚¹ï¼Œæ˜¯å­¦ç”Ÿå¤–å‡ºä¸è¿”æ ¡çš„é‡è¦é€šé“ã€‚",
                "color": "#4CAF50"
            },
            {
                "id": 3,
                "name": "åŒ—é—¨",
                "lng": 113.35885,
                "lat": 23.170442,
                "category": "æ ¡é—¨",
                "description": "æ ¡å›­åŒ—é—¨ï¼Œé è¿‘æ ¡åŒ»é™¢ä¸æ•™èŒå·¥ä½å®…åŒºï¼Œå‘¨è¾¹ç¯å¢ƒå®‰é™ï¼Œå¤šä¸ºæ•™èŒå·¥åŠè½¦è¾†è¿›å‡ºä½¿ç”¨ã€‚",
                "color": "#4CAF50"
            },
            {
                "id": 4,
                "name": "ä¸œåŒ—é—¨",
                "lng": 113.37049,
                "lat": 23.165554,
                "category": "æ ¡é—¨",
                "description": "ä½äºæ ¡å›­ä¸œåŒ—ä¾§ï¼Œé‚»è¿‘å¯æ—å®¿èˆåŒºä¸ç¬¬å››æ•™å­¦æ¥¼ï¼Œæ˜¯å­¦ç”Ÿå‰å¾€ä¸œä¾§æ•™å­¦åŒºä¸ç”Ÿæ´»åŒºçš„ä¸»è¦å…¥å£ã€‚",
                "color": "#4CAF50"
            },
            {
                "id": 5,
                "name": "æ–°æ­£é—¨",
                "lng": 113.363727,
                "lat": 23.158383,
                "category": "æ ¡é—¨",
                "description": "æ ¡å›­æ­£é—¨ï¼Œæ°”åŠ¿æ¢å®ï¼Œä¸ºå­¦æ ¡å½¢è±¡å±•ç¤ºçª—å£ï¼Œé—¨å‰è®¾æœ‰å¹¿åœºï¼Œå¸¸ç”¨äºå¤§å‹æ´»åŠ¨æ¥å¾…ä¸æ‹ç…§ç•™å¿µã€‚",
                "color": "#4CAF50"
            },
            {
                "id": 6,
                "name": "ç¬¬ä¸€æ•™å­¦æ¥¼",
                "lng": 113.356911,
                "lat": 23.16485,
                "category": "æ•™å­¦å»ºç­‘",
                "description": "å†å²æ‚ ä¹…çš„æ•™å­¦æ¥¼ï¼Œä»¥åŸºç¡€è¯¾ç¨‹æ•™å­¦ä¸ºä¸»ï¼Œæ•™å®¤è®¾å¤‡é½å…¨ï¼Œå‘¨è¾¹ç»¿æ ‘ç¯ç»•ï¼Œå­¦ä¹ æ°›å›´æµ“åšã€‚",
                "color": "#2196F3"
            },
            {
                "id": 7,
                "name": "ç¬¬äºŒæ•™å­¦æ¥¼",
                "lng": 113.353757,
                "lat": 23.16446,
                "category": "æ•™å­¦å»ºç­‘",
                "description": "ç°ä»£åŒ–æ•™å­¦æ¥¼ï¼Œé…å¤‡å¤šåª’ä½“æ•™å®¤ä¸å®éªŒå®¤ï¼Œå¸¸ç”¨äºç†å·¥ç§‘è¯¾ç¨‹æ•™å­¦ä¸å­¦ç”Ÿè‡ªä¹ ã€‚",
                "color": "#2196F3"
            },
            {
                "id": 8,
                "name": "ç¬¬ä¸‰æ•™å­¦æ¥¼",
                "lng": 113.358397,
                "lat": 23.163976,
                "category": "æ•™å­¦å»ºç­‘",
                "description": "å¤šå±‚æ•™å­¦æ¥¼ï¼Œè®¾æœ‰é˜¶æ¢¯æ•™å®¤ä¸ç ”è®¨å®¤ï¼Œæ˜¯å…¬å…±è¯¾ä¸å­¦æœ¯è®²åº§çš„ä¸»è¦åœºæ‰€ï¼Œæ¯—é‚»å›¾ä¹¦é¦†ä¸è¡Œæ”¿æ¥¼ã€‚",
                "color": "#2196F3"
            },
            {
                "id": 9,
                "name": "ç¬¬å››æ•™å­¦æ¥¼",
                "lng": 113.372069,
                "lat": 23.157942,
                "category": "æ•™å­¦å»ºç­‘",
                "description": "ä½äºæ ¡å›­ä¸œä¾§çš„æ–°å»ºæ•™å­¦æ¥¼ï¼Œè®¾è®¡ç°ä»£ï¼Œè®¾æ–½å…ˆè¿›ï¼Œä¸»è¦ç”¨äºä¿¡æ¯æŠ€æœ¯ä¸å·¥ç¨‹ç±»è¯¾ç¨‹æ•™å­¦ã€‚",
                "color": "#2196F3"
            },
            {
                "id": 10,
                "name": "ç¬¬äº”æ•™å­¦æ¥¼",
                "lng": 113.372385,
                "lat": 23.166407,
                "category": "æ•™å­¦å»ºç­‘",
                "description": "å¯æ—åŒºä¸»è¦æ•™å­¦æ¥¼ï¼Œé è¿‘å®¿èˆåŒºï¼Œæ–¹ä¾¿å­¦ç”Ÿä¸Šä¸‹è¯¾ï¼Œæ•™å®¤å®½æ•æ˜äº®ï¼Œå¸¸ç”¨äºä¸“ä¸šè¯¾ç¨‹æ•™å­¦ä¸è€ƒè¯•ã€‚",
                "color": "#2196F3"
            },
            {
                "id": 11,
                "name": "èµ„æºç¯å¢ƒå­¦é™¢",
                "lng": 113.365823,
                "lat": 23.167593,
                "category": "å­¦é™¢å»ºç­‘",
                "description": "èµ„æºç¯å¢ƒå­¦é™¢ç‹¬ç«‹é™¢æ¥¼ï¼Œé›†æ•™å­¦ã€ç§‘ç ”ã€åŠå…¬äºä¸€ä½“ï¼Œè®¾æœ‰å®éªŒå®¤ä¸ç ”ç©¶ä¸­å¿ƒï¼Œèšç„¦ç¯å¢ƒç§‘å­¦ä¸å¯æŒç»­å‘å±•ã€‚",
                "color": "#3F51B5"
            },
            {
                "id": 12,
                "name": "æ•°å­¦ä¸ä¿¡æ¯è½¯ä»¶å­¦é™¢",
                "lng": 113.357705,
                "lat": 23.166463,
                "category": "å­¦é™¢å»ºç­‘",
                "description": "æ•°å­¦ä¸ä¿¡æ¯è½¯ä»¶å­¦é™¢æ‰€åœ¨åœ°ï¼Œæ‹¥æœ‰é«˜æ€§èƒ½è®¡ç®—å®éªŒå®¤ä¸è½¯ä»¶å·¥ç¨‹å®è®­ä¸­å¿ƒï¼ŒåŸ¹å…»ä¿¡æ¯æŠ€æœ¯ä¸æ•°å­¦åº”ç”¨äººæ‰ã€‚",
                "color": "#3F51B5"
            },
            {
                "id": 13,
                "name": "è¡Œæ”¿æ¥¼",
                "lng": 113.360202,
                "lat": 23.16154,
                "category": "è¡Œæ”¿åŠå…¬",
                "description": "å­¦æ ¡æ ¸å¿ƒè¡Œæ”¿åŠå…¬å¤§æ¥¼ï¼Œè®¾æœ‰æ ¡é¢†å¯¼åŠå…¬å®¤åŠå„èŒèƒ½éƒ¨é—¨ï¼Œæ˜¯å­¦æ ¡ç®¡ç†ä¸å†³ç­–ä¸­å¿ƒï¼Œå»ºç­‘åº„é‡å¤§æ°”ã€‚",
                "color": "#607D8B"
            },
            {
                "id": 14,
                "name": "æ•™ä¸‰å¤§è‰åª",
                "lng": 113.35738,
                "lat": 23.162831,
                "category": "å…¬å…±ç©ºé—´",
                "description": "æ•™ä¸‰å¤§æ¥¼å‰å¼€é˜”è‰åªï¼Œæ˜¯å­¦ç”Ÿä¼‘é—²ã€ç¤¾å›¢æ´»åŠ¨ã€æˆ·å¤–è¯»ä¹¦çš„å¸¸ç”¨åœºæ‰€ï¼Œæ˜¥ç§‹å­£èŠ‚å¸¸ä¸¾åŠæ ¡å›­æ–‡åŒ–æ´»åŠ¨ã€‚",
                "color": "#FFC107"
            },
            {
                "id": 15,
                "name": "å›¾ä¹¦é¦†",
                "lng": 113.360213,
                "lat": 23.163381,
                "category": "æ–‡åŒ–è®¾æ–½",
                "description": "å­¦æ ¡æ ‡å¿—æ€§å»ºç­‘ä¹‹ä¸€ï¼Œé¦†è—ä¸°å¯Œï¼Œè®¾æœ‰é˜…è§ˆå®¤ã€è‡ªä¹ åŒºã€å¤šåª’ä½“ä¸­å¿ƒä¸å­¦æœ¯è®¨è®ºå®¤ï¼Œæ˜¯å­¦ç”Ÿå­¦ä¹ ä¸ç ”ç©¶çš„é‡è¦åœºæ‰€ã€‚",
                "color": "#795548"
            },
            {
                "id": 16,
                "name": "åšç‰©é¦†",
                "lng": 113.35838,
                "lat": 23.162818,
                "category": "æ–‡åŒ–è®¾æ–½",
                "description": "æ”¶è—ä¸å±•ç¤ºå­¦æ ¡å†å²ã€è‡ªç„¶ç§‘å­¦ä¸äººæ–‡è‰ºæœ¯è—å“ï¼Œå®šæœŸä¸¾åŠä¸“é¢˜å±•è§ˆï¼Œæ˜¯æ ¡å›­æ–‡åŒ–æ•™è‚²ä¸å‚è§‚çš„é‡è¦çª—å£ã€‚",
                "color": "#795548"
            },
            {
                "id": 17,
                "name": "æ ¡å²é¦†",
                "lng": 113.356072,
                "lat": 23.162939,
                "category": "æ–‡åŒ–è®¾æ–½",
                "description": "ç³»ç»Ÿå±•ç¤ºå­¦æ ¡å‘å±•å†ç¨‹ã€é‡å¤§äº‹ä»¶ä¸æ°å‡ºæ ¡å‹çš„ä¸“é—¨åœºé¦†ï¼Œæ˜¯æ–°ç”Ÿå…¥å­¦æ•™è‚²ä¸æ ¡å²å­¦ä¹ çš„é‡è¦åŸºåœ°ã€‚",
                "color": "#795548"
            },
            {
                "id": 18,
                "name": "æ¹¿åœ°å…¬å›­",
                "lng": 113.361619,
                "lat": 23.15965,
                "category": "è‡ªç„¶æ™¯è§‚",
                "description": "æ ¡å›­å†…ç”Ÿæ€æ¹¿åœ°å…¬å›­ï¼Œæ‹¥æœ‰ä¸°å¯Œçš„æ°´ç”Ÿæ¤ç‰©ä¸é¸Ÿç±»ï¼Œè®¾æœ‰æ­¥é“ä¸è§‚æ™¯å°ï¼Œå…¼å…·ç”Ÿæ€ä¿æŠ¤ã€æ•™å­¦ç ”ç©¶ä¸ä¼‘é—²åŠŸèƒ½ã€‚",
                "color": "#8BC34A"
            },
            {
                "id": 19,
                "name": "çŸ³åŠé’Ÿäº­",
                "lng": 113.355118,
                "lat": 23.162437,
                "category": "æ–‡åŒ–æ™¯è§‚",
                "description": "å…·æœ‰å†å²æ„ä¹‰çš„çŸ³åŠä¸é’Ÿäº­ï¼Œä¸ºæ ¡å›­æ—©æœŸå»ºç­‘é—å­˜ï¼Œå‘¨å›´ç»¿æ ‘æ©æ˜ ï¼Œæ˜¯å¸ˆç”Ÿæ€€æ—§ä¸ä¼‘æ†©çš„å®‰é™è§’è½ã€‚",
                "color": "#795548"
            },
            {
                "id": 20,
                "name": "çº¢æ»¡å ‚",
                "lng": 113.358428,
                "lat": 23.162159,
                "category": "æ–‡åŒ–è®¾æ–½",
                "description": "æ ¡å›­é‡è¦æ–‡åŒ–åœ°æ ‡ï¼Œå¸¸ä¸¾åŠå­¦æœ¯æŠ¥å‘Šã€æ–‡è‰ºæ¼”å‡ºã€åº†å…¸æ´»åŠ¨ç­‰ï¼Œå†…éƒ¨è®¾è®¡å…¸é›…ï¼Œå…·æœ‰æµ“åšçš„å­¦æœ¯ä¸è‰ºæœ¯æ°›å›´ã€‚",
                "color": "#795548"
            },
            {
                "id": 21,
                "name": "å¤©æ–‡å°",
                "lng": 113.357614,
                "lat": 23.165954,
                "category": "ç§‘ç ”è®¾æ–½",
                "description": "é…å¤‡ä¸“ä¸šå¤©æ–‡æœ›è¿œé•œä¸è§‚æµ‹è®¾å¤‡ï¼Œç”¨äºå¤©æ–‡æ•™å­¦ã€ç§‘æ™®æ´»åŠ¨ä¸ç§‘ç ”è§‚æµ‹ï¼Œå®šæœŸå‘å¸ˆç”Ÿå¼€æ”¾è§‚æµ‹æ´»åŠ¨ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 22,
                "name": "æ ‘æœ¨å›­",
                "lng": 113.366445,
                "lat": 23.159389,
                "category": "è‡ªç„¶æ™¯è§‚",
                "description": "é›†ä¸­ç§æ¤å„ç±»æ ‘æœ¨ä¸æ¤ç‰©çš„å›­åŒºï¼Œå…¼å…·æ•™å­¦å®ä¹ ã€ç‰©ç§ä¿æŠ¤ä¸è§‚èµåŠŸèƒ½ï¼Œæ˜¯æ ¡å›­å†…é‡è¦çš„ç”Ÿæ€æ•™å­¦åŸºåœ°ã€‚",
                "color": "#8BC34A"
            },
            {
                "id": 23,
                "name": "ç»¼åˆä½“è‚²é¦†",
                "lng": 113.361619,
                "lat": 23.15965,
                "category": "ä½“è‚²è®¾æ–½",
                "description": "ç°ä»£åŒ–å¤šåŠŸèƒ½ä½“è‚²é¦†ï¼Œè®¾æœ‰ç¯®çƒåœºã€ç¾½æ¯›çƒåœºã€æ¸¸æ³³æ± ç­‰è®¾æ–½ï¼Œæ‰¿åŠä½“è‚²èµ›äº‹ã€å¤§å‹æ´»åŠ¨ä¸å­¦ç”Ÿä½“è‚²é”»ç‚¼ã€‚",
                "color": "#009688"
            },
            {
                "id": 24,
                "name": "ç«¹å›­å®¾é¦†",
                "lng": 113.362854,
                "lat": 23.160973,
                "category": "ä½å®¿æœåŠ¡",
                "description": "æ ¡å›­å†…çš„å®¾é¦†è®¾æ–½ï¼Œä¸»è¦ä¸ºæ¥è®¿å­¦è€…ã€æ ¡å‹åŠå®¶é•¿æä¾›ä½å®¿æœåŠ¡ï¼Œç¯å¢ƒæ¸…å¹½ï¼Œé…å¥—é½å…¨ï¼Œä¾¿äºæ ¡å†…æ´»åŠ¨ã€‚",
                "color": "#FF9800"
            },
            {
                "id": 25,
                "name": "æ ¡åŒ»é™¢",
                "lng": 113.359738,
                "lat": 23.170072,
                "category": "åŒ»ç–—æœåŠ¡",
                "description": "ä¸ºå…¨æ ¡å¸ˆç”Ÿæä¾›åŸºæœ¬åŒ»ç–—ã€å¥åº·å’¨è¯¢ã€æ€¥æ•‘ä¸é¢„é˜²ä¿å¥æœåŠ¡çš„åŒ»ç–—æœºæ„ï¼Œè®¾æœ‰é—¨è¯Šéƒ¨ã€è¯æˆ¿ä¸ä½é™¢éƒ¨ã€‚",
                "color": "#E91E63"
            },
            {
                "id": 26,
                "name": "ç»¿æ¦•å›­",
                "lng": 113.360202,
                "lat": 23.16154,
                "category": "è‡ªç„¶æ™¯è§‚",
                "description": "ä»¥æ¦•æ ‘ä¸ºä¸»é¢˜çš„å›­æ—æ™¯è§‚ï¼Œç»¿è«å¦‚ç›–ï¼Œè®¾æœ‰äº­å°ä¸æ­¥é“ï¼Œæ˜¯å¸ˆç”Ÿæ•£æ­¥ã€æ™¨è¯»ä¸ä¼‘é—²çš„ç†æƒ³åœºæ‰€ã€‚",
                "color": "#8BC34A"
            },
            {
                "id": 27,
                "name": "è¥¿å›­",
                "lng": 113.354185,
                "lat": 23.167152,
                "category": "ç”Ÿæ´»æœåŠ¡",
                "description": "æ ¡å›­è¥¿åŒºä¸»è¦é£Ÿå ‚ä¹‹ä¸€ï¼Œæä¾›å¤šæ ·åŒ–çš„é¤é¥®é€‰æ‹©ï¼Œä»·æ ¼å®æƒ ï¼Œæ˜¯é™„è¿‘å®¿èˆå­¦ç”Ÿæ—¥å¸¸å°±é¤çš„ä¸»è¦åœºæ‰€ã€‚",
                "color": "#FF5722"
            },
            {
                "id": 28,
                "name": "è·å›­",
                "lng": 113.37391,
                "lat": 23.166931,
                "category": "ç”Ÿæ´»æœåŠ¡",
                "description": "å¯æ—åŒºå¤§å‹é£Ÿå ‚ï¼Œç¯å¢ƒæ•´æ´ï¼Œèœå“ç§ç±»ä¸°å¯Œï¼Œè®¾æœ‰é£å‘³çª—å£ä¸ä¼‘é—²å°±é¤åŒºï¼Œæ·±å—å­¦ç”Ÿæ¬¢è¿ã€‚",
                "color": "#FF5722"
            },
            {
                "id": 29,
                "name": "èŠ·å›­",
                "lng": 113.37391,
                "lat": 23.166931,
                "category": "ç”Ÿæ´»æœåŠ¡",
                "description": "å¯æ—åŒºå¦ä¸€ä¸»è¦é£Ÿå ‚ï¼Œä»¥ç‰¹è‰²å°åƒä¸å¤œå®µé—»åï¼Œæ˜¯å­¦ç”Ÿèšé¤ä¸å¤œé—´æ´»åŠ¨çš„çƒ­é—¨åœ°ç‚¹ã€‚",
                "color": "#FF5722"
            },
            {
                "id": 30,
                "name": "è˜å›­",
                "lng": 113.36376,
                "lat": 23.169106,
                "category": "ç”Ÿæ´»æœåŠ¡",
                "description": "ä½äºåµ©å±±åŒºçš„ç”Ÿæ´»æœåŠ¡åŒºï¼Œé›†é£Ÿå ‚ã€è¶…å¸‚ã€ä¾¿åˆ©åº—äºä¸€ä½“ï¼Œæ–¹ä¾¿å‘¨è¾¹å®¿èˆå­¦ç”Ÿæ—¥å¸¸è´­ç‰©ä¸å°±é¤ã€‚",
                "color": "#FF5722"
            },
            {
                "id": 31,
                "name": "ç¨»é¦™å›­",
                "lng": 113.376884,
                "lat": 23.169393,
                "category": "ç”Ÿæ´»æœåŠ¡",
                "description": "é è¿‘å¯æ—åŒ—å®¿èˆåŒºçš„é£Ÿå ‚ï¼Œä»¥ç»æµå®æƒ çš„å®¶å¸¸èœä¸ºä¸»ï¼Œæ˜¯å­¦ç”Ÿæ—¥å¸¸ç”¨é¤ä¸äº¤æµçš„é‡è¦åœºæ‰€ã€‚",
                "color": "#FF5722"
            },
            {
                "id": 32,
                "name": "å¯æ—å—å®¿èˆåŒº",
                "lng": 113.373916,
                "lat": 23.165421,
                "category": "å®¿èˆåŒº",
                "description": "å¯æ—å—ç‰‡åŒºå­¦ç”Ÿå®¿èˆç¾¤ï¼Œå¤šä¸ºå¤šå±‚å»ºç­‘ï¼Œå±…ä½ç¯å¢ƒèˆ’é€‚ï¼Œå‘¨è¾¹æœ‰é£Ÿå ‚ã€è¶…å¸‚ä¸è¿åŠ¨è®¾æ–½ï¼Œç”Ÿæ´»ä¾¿åˆ©ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 33,
                "name": "å¯æ—åŒ—å®¿èˆåŒº",
                "lng": 113.377267,
                "lat": 23.169022,
                "category": "å®¿èˆåŒº",
                "description": "å¯æ—åŒ—ç‰‡åŒºå®¿èˆåŒºï¼Œæ–°å»ºå®¿èˆæ¥¼è®¾æ–½ç°ä»£åŒ–ï¼Œé…å¤‡è‡ªä¹ å®¤ä¸æ´»åŠ¨ç©ºé—´ï¼Œå±…ä½æ¡ä»¶è¾ƒå¥½ï¼Œé è¿‘æ•™å­¦åŒºä¸é£Ÿå ‚ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 34,
                "name": "æ³°å±±å®¿èˆåŒº",
                "lng": 113.375143,
                "lat": 23.15881,
                "category": "å®¿èˆåŒº",
                "description": "æ³°å±±ç‰‡åŒºå­¦ç”Ÿå®¿èˆï¼Œä»¥é«˜å±‚å»ºç­‘ä¸ºä¸»ï¼Œè§†é‡å¼€é˜”ï¼Œå†…éƒ¨è®¾æ–½é½å…¨ï¼Œå‘¨è¾¹æœ‰ç¯®çƒåœºã€ä¾¿åˆ©åº—ç­‰ç”Ÿæ´»é…å¥—ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 35,
                "name": "åå±±å®¿èˆåŒº",
                "lng": 113.352909,
                "lat": 23.165371,
                "category": "å®¿èˆåŒº",
                "description": "åå±±ç‰‡åŒºå®¿èˆåŒºï¼Œé è¿‘è¥¿é—¨ä¸è¿åŠ¨åœºï¼Œå‡ºå…¥æ–¹ä¾¿ï¼Œå®¿èˆæ¥¼é—´è·è¾ƒå¤§ï¼Œç¯å¢ƒå®‰é™ï¼Œé€‚åˆå­¦ä¹ ä¸ä¼‘æ¯ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 36,
                "name": "åµ©å±±ä½å®…åŒº",
                "lng": 113.363563,
                "lat": 23.163789,
                "category": "ä½å®…åŒº",
                "description": "ä¸»è¦ä¸ºæ•™èŒå·¥åŠå…¶å®¶å±æä¾›çš„ä½å®…åŒºï¼Œç¯å¢ƒå®‰é™ï¼Œç»¿åŒ–è‰¯å¥½ï¼Œé…æœ‰å°å‹å…¬å›­ä¸å¥èº«è®¾æ–½ï¼Œç”Ÿæ´»ä¾¿åˆ©ã€‚",
                "color": "#673AB7"
            },
            {
                "id": 37,
                "name": "é»‘å±±å®¿èˆåŒº",
                "lng": 113.362395,
                "lat": 23.158991,
                "category": "å®¿èˆåŒº",
                "description": "é»‘å±±ç‰‡åŒºå­¦ç”Ÿå®¿èˆï¼Œå¤šä¸ºè¾ƒæ—§å»ºç­‘ï¼Œä½†ä½ç½®ä¼˜è¶Šï¼Œé è¿‘æ•™å­¦åŒºä¸é£Ÿå ‚ï¼Œç”Ÿæ´»ä¸å­¦ä¹ äº¤é€šä¾¿åˆ©ã€‚",
                "color": "#9C27B0"
            },
            {
                "id": 38,
                "name": "ç‡•å±±å®¿èˆåŒº",
                "lng": 113.36626,
                "lat": 23.168375,
                "category": "å®¿èˆåŒº",
                "description": "ç‡•å±±ç‰‡åŒºå®¿èˆåŒºï¼Œå®¿èˆæ¥¼è¾ƒæ–°ï¼Œå†…éƒ¨è®¾æ–½å®Œå–„ï¼Œå‘¨è¾¹æœ‰è¶…å¸‚ã€å¿«é€’ç‚¹ç­‰ç”Ÿæ´»æœåŠ¡ï¼Œå±…ä½ä½“éªŒè¾ƒå¥½ã€‚",
                "color": "#9C27B0"
            }
        ];
    </script>

    <script>
        // ä¸»åº”ç”¨ç¨‹åºé€»è¾‘
        const App = {
            // åº”ç”¨ç¨‹åºçŠ¶æ€
            state: {
                map: null,
                buildings: [],
                markers: [],
                activeBuildingId: null,
                activeCategory: 'all',
                legendVisible: true,
                navigationVisible: false,
                customMarkers: [],
                currentLocation: null,
                isMapInitialized: false,
                
                // æµ‹é‡å·¥å…·çŠ¶æ€
                measureMode: null,
                measurePoints: [],
                measureMarkers: [],      
                measurePolylines: [],    
                measurePolygon: null,    
                isMeasuring: false,
                isMapLocked: false,      
                
                // è·¯çº¿è§„åˆ’ç›¸å…³
                walkingRoute: null,
                drivingRoute: null,
                routePolyline: null,
                routeMarkers: [],
                
                // è·¯çº¿å¯¼èˆªçŠ¶æ€
                routeSteps: [],
                currentStepIndex: 0,
                
                // é¢æ¿æ‹–åŠ¨çŠ¶æ€
                isDragging: false,
                dragOffset: { x: 0, y: 0 },
                dragElement: null,
                
                // ç¼“å­˜å›¾æ ‡
                iconCache: {},
                
                // ç”¨äºå­˜å‚¨çªå‡ºæ ‡ç­¾
                highlightLabel: null,
                
                // å½“å‰çªå‡ºæ˜¾ç¤ºçš„æ ‡è®°
                highlightedMarker: null,
                highlightTimeout: null,
                
                // åœ°å›¾äº¤äº’çŠ¶æ€è®°å½•
                mapOriginalState: {
                    enableDragging: true,
                    enableScrollWheelZoom: true,
                    enableDoubleClickZoom: true,
                    enableKeyboard: true
                },
                
                // å®šä½ç›¸å…³çŠ¶æ€
                isLocating: false,
                locationMarker: null,
                accuracyCircle: null,
                locationInfo: null,
                locationWatchId: null,
                currentPosition: null,
                // ç™¾åº¦åœ°å›¾å®šä½æœåŠ¡
                geolocation: null,
                
                // åæ ‡è½¬æ¢ç›¸å…³
                coordConvertor: null,
                conversionCache: {}
            },

            // ç±»åˆ«é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
            categoryConfig: {
                'æ ¡é—¨': { icon: 'ğŸšª', count: 5 },
                'æ•™å­¦å»ºç­‘': { icon: 'ğŸ«', count: 5 },
                'å­¦é™¢å»ºç­‘': { icon: 'ğŸ¢', count: 2 },
                'è¡Œæ”¿åŠå…¬': { icon: 'ğŸ’¼', count: 1 },
                'å…¬å…±ç©ºé—´': { icon: 'ğŸŒ³', count: 1 },
                'æ–‡åŒ–è®¾æ–½': { icon: 'ğŸ›ï¸', count: 5 },
                'è‡ªç„¶æ™¯è§‚': { icon: 'ğŸŒ¿', count: 3 },
                'ç§‘ç ”è®¾æ–½': { icon: 'ğŸ”¬', count: 1 },
                'ä½“è‚²è®¾æ–½': { icon: 'âš½', count: 1 },
                'ä½å®¿æœåŠ¡': { icon: 'ğŸ›ï¸', count: 1 },
                'åŒ»ç–—æœåŠ¡': { icon: 'ğŸ¥', count: 1 },
                'ç”Ÿæ´»æœåŠ¡': { icon: 'ğŸ½ï¸', count: 5 },
                'å®¿èˆåŒº': { icon: 'ğŸ ', count: 6 },
                'ä½å®…åŒº': { icon: 'ğŸ¡', count: 1 }
            },

            // åˆå§‹åŒ–åº”ç”¨ç¨‹åº
            init: function() {
                console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨ç¨‹åº...');
                this.state.buildings = buildingsData || [];
                this.updateBuildingCount();
                
                // ç­‰å¾…ç™¾åº¦åœ°å›¾APIåŠ è½½
                this.waitForBaiduMaps(() => {
                    console.log('ç™¾åº¦åœ°å›¾APIå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–åœ°å›¾...');
                    this.initMap();
                    this.initUI();
                    this.renderCategoryFilter();
                    this.renderBuildingsList(this.state.buildings);
                    this.createLegend();
                    this.initRouteOptions();
                    
                    // éšè—åŠ è½½æç¤º
                    setTimeout(() => {
                        document.getElementById('route-loading').classList.remove('active');
                    }, 1000);
                    
                    // ç¡®ä¿åœ°å›¾åˆå§‹çŠ¶æ€æ˜¯è§£é”çš„
                    this.ensureMapUnlocked();
                });
            },

            // æ–°å¢ï¼šç¡®ä¿åœ°å›¾å¤„äºè§£é”çŠ¶æ€
            ensureMapUnlocked: function() {
                // å¦‚æœåœ°å›¾å·²åˆå§‹åŒ–ï¼Œç¡®ä¿å®ƒæ˜¯è§£é”çŠ¶æ€
                if (this.state.map && this.state.isMapLocked) {
                    console.log('æ£€æµ‹åˆ°åœ°å›¾å¤„äºé”å®šçŠ¶æ€ï¼Œæ­£åœ¨è§£é”...');
                    this.unlockMap();
                }
                
                // ç¡®ä¿é”å®šæŒ‰é’®æ˜¾ç¤ºæ­£ç¡®çŠ¶æ€
                const lockBtn = document.getElementById('lock-map-btn');
                if (lockBtn) {
                    lockBtn.classList.remove('active');
                    lockBtn.innerHTML = 'ğŸ”’ é”å®šåœ°å›¾';
                }
                
                // ç¡®ä¿åœ°å›¾é”å®šæç¤ºéšè—
                const lockIndicator = document.getElementById('map-lock-indicator');
                if (lockIndicator) {
                    lockIndicator.classList.remove('active');
                }
            },

            // ç­‰å¾…ç™¾åº¦åœ°å›¾APIåŠ è½½
            waitForBaiduMaps: function(callback) {
                const maxAttempts = 30;
                let attempts = 0;
                
                const check = () => {
                    if (typeof BMap !== 'undefined') {
                        console.log('ç™¾åº¦åœ°å›¾APIåŠ è½½æˆåŠŸ');
                        callback();
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        console.log(`ç­‰å¾…ç™¾åº¦åœ°å›¾APIåŠ è½½... (${attempts}/${maxAttempts})`);
                        setTimeout(check, 500);
                    } else {
                        console.error('ç™¾åº¦åœ°å›¾APIåŠ è½½è¶…æ—¶');
                        document.getElementById('route-error').innerHTML = 'ç™¾åº¦åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                        document.getElementById('route-error').classList.add('active');
                    }
                };
                
                check();
            },

            // åˆå§‹åŒ–è·¯å¾„è§„åˆ’ä¸‹æ‹‰é€‰é¡¹
            initRouteOptions: function() {
                const startSelect = document.getElementById('route-start');
                const endSelect = document.getElementById('route-end');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æˆ‘çš„ä½ç½®"é€‰é¡¹ï¼‰
                while (startSelect.options.length > 2) startSelect.remove(2);
                while (endSelect.options.length > 2) endSelect.remove(2);
                
                // æ·»åŠ å»ºç­‘é€‰é¡¹
                this.state.buildings.forEach(building => {
                    const startOption = document.createElement('option');
                    startOption.value = `${building.lng},${building.lat}`;
                    startOption.textContent = building.name;
                    startSelect.appendChild(startOption.cloneNode(true));
                    
                    const endOption = startOption.cloneNode(true);
                    endSelect.appendChild(endOption);
                });
            },

            // æ›´æ–°å»ºç­‘æ•°é‡æ˜¾ç¤º
            updateBuildingCount: function() {
                const countElement = document.getElementById('building-count');
                if (countElement) {
                    countElement.textContent = this.state.buildings.length;
                }
            },

            // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾ - ä¿®å¤ï¼šç¡®ä¿åœ°å›¾åˆå§‹çŠ¶æ€æ­£å¸¸
            initMap: function() {
                try {
                    // æ£€æŸ¥BMapå¯¹è±¡æ˜¯å¦å·²åŠ è½½
                    if (typeof BMap === 'undefined') {
                        throw new Error('ç™¾åº¦åœ°å›¾APIæœªåŠ è½½æˆåŠŸ');
                    }
                    
                    // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆåå†œä¸­å¿ƒåæ ‡ï¼‰
                    this.state.map = new BMap.Map("map");
                    const point = new BMap.Point(113.363727, 23.158383);
                    this.state.map.centerAndZoom(point, 16);
                    
                    // å¯ç”¨æ»šè½®ç¼©æ”¾
                    this.state.map.enableScrollWheelZoom(true);
                    
                    // æ·»åŠ åœ°å›¾æ§ä»¶
                    this.state.map.addControl(new BMap.NavigationControl());
                    this.state.map.addControl(new BMap.ScaleControl());
                    
                    // æ·»åŠ åœ°å›¾ç±»å‹æ§ä»¶
                    const mapTypeControl = new BMap.MapTypeControl({
                        mapTypes: [BMAP_NORMAL_MAP, BMAP_SATELLITE_MAP, BMAP_HYBRID_MAP]
                    });
                    this.state.map.addControl(mapTypeControl);
                    
                    // è®¾ç½®é»˜è®¤åœ°å›¾ç±»å‹ä¸ºæ™®é€šåœ°å›¾
                    this.state.map.setMapType(BMAP_NORMAL_MAP);
                    
                    // æ ‡è®°åœ°å›¾åˆå§‹åŒ–æˆåŠŸ
                    this.state.isMapInitialized = true;
                    
                    // é‡è¦ï¼šé‡ç½®åœ°å›¾çŠ¶æ€ï¼Œç¡®ä¿å¯äº¤äº’
                    this.resetMapState();
                    
                    // åˆ›å»ºå»ºç­‘æ ‡è®°
                    this.createMarkers();
                    
                    // åˆå§‹åŒ–çªå‡ºæ ‡ç­¾
                    this.state.highlightLabel = document.getElementById('highlight-label');
                    
                    // åˆå§‹åŒ–ç™¾åº¦åœ°å›¾å®šä½æœåŠ¡
                    this.state.geolocation = new BMap.Geolocation();
                    
                    // åˆå§‹åŒ–åæ ‡è½¬æ¢å™¨
                    this.initCoordConverter();
                    
                    // æ·»åŠ åœ°å›¾ç‚¹å‡»äº‹ä»¶ç”¨äºæµ‹é‡
                    this.state.map.addEventListener('click', (e) => {
                        this.handleMapClickForMeasurement(e);
                    });
                    
                    console.log('åœ°å›¾åˆå§‹åŒ–æˆåŠŸ');
                    
                } catch (error) {
                    console.error('åœ°å›¾åˆå§‹åŒ–é”™è¯¯:', error);
                    this.state.isMapInitialized = false;
                    document.getElementById('route-error').innerHTML = 'åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                    document.getElementById('route-error').classList.add('active');
                }
            },

            // åˆå§‹åŒ–åæ ‡è½¬æ¢å™¨
            initCoordConverter: function() {
                if (typeof BMap.Convertor !== 'undefined') {
                    this.state.coordConvertor = new BMap.Convertor();
                } else {
                    console.warn('ç™¾åº¦åœ°å›¾åæ ‡è½¬æ¢å™¨ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨è¿‘ä¼¼è½¬æ¢');
                }
            },

            // æ–°å¢ï¼šé‡ç½®åœ°å›¾çŠ¶æ€ï¼Œç¡®ä¿å¯äº¤äº’
            resetMapState: function() {
                if (!this.state.map) return;
                
                // å¯ç”¨æ‰€æœ‰äº¤äº’
                this.state.map.enableDragging();
                this.state.map.enableScrollWheelZoom(true);
                this.state.map.enableDoubleClickZoom();
                this.state.map.enableKeyboard();
                
                // é‡ç½®çŠ¶æ€
                this.state.isMapLocked = false;
                
                console.log('åœ°å›¾çŠ¶æ€å·²é‡ç½®ä¸ºå¯äº¤äº’çŠ¶æ€');
            },

            // ================== æµ‹é‡å·¥å…·åŠŸèƒ½ ==================
            
            // å¤„ç†åœ°å›¾ç‚¹å‡»äº‹ä»¶ç”¨äºæµ‹é‡
            handleMapClickForMeasurement: function(e) {
                if (!this.state.isMeasuring || !this.state.measureMode) return;
                
                const point = e.point;
                this.addMeasurePoint(point.lng, point.lat);
            },

            // æ·»åŠ æµ‹é‡ç‚¹
            addMeasurePoint: function(lng, lat) {
                if (!this.state.isMeasuring) return;
                
                // æ·»åŠ ç‚¹åˆ°æ•°ç»„
                const newPoint = {lng: lng, lat: lat};
                this.state.measurePoints.push(newPoint);
                
                // åˆ›å»ºæµ‹é‡ç‚¹æ ‡è®°ï¼ˆç™¾åº¦åœ°å›¾Markerï¼‰
                this.createMeasureMarker(newPoint);
                
                // æ›´æ–°æµ‹é‡çº¿æˆ–é¢ç§¯
                this.updateMeasurement();
                
                // æ›´æ–°æµ‹é‡ç»“æœæ˜¾ç¤º
                this.updateMeasureResults();
            },

            // åˆ›å»ºæµ‹é‡ç‚¹æ ‡è®°
            createMeasureMarker: function(point) {
                const mapPoint = new BMap.Point(point.lng, point.lat);
                
                // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
                const icon = this.createMeasureMarkerIcon();
                
                // åˆ›å»ºMarker
                const marker = new BMap.Marker(mapPoint, {icon: icon});
                
                // æ·»åŠ æ ‡ç­¾æ˜¾ç¤ºåºå·
                const index = this.state.measurePoints.length;
                const label = new BMap.Label(index.toString(), {
                    offset: new BMap.Size(-8, -30),
                    style: {
                        color: '#FF5722',
                        backgroundColor: 'white',
                        padding: '2px 6px',
                        borderRadius: '3px',
                        fontSize: '12px',
                        fontWeight: 'bold',
                        border: '1px solid #ddd'
                    }
                });
                marker.setLabel(label);
                
                // æ·»åŠ åˆ°åœ°å›¾
                this.state.map.addOverlay(marker);
                this.state.measureMarkers.push(marker);
            },

            // åˆ›å»ºæµ‹é‡ç‚¹å›¾æ ‡
            createMeasureMarkerIcon: function() {
                // ä½¿ç”¨Canvasåˆ›å»ºå›¾æ ‡
                const canvas = document.createElement('canvas');
                canvas.width = 20;
                canvas.height = 20;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶åœ†å½¢
                ctx.beginPath();
                ctx.arc(10, 10, 8, 0, Math.PI * 2);
                ctx.fillStyle = '#FF5722';
                ctx.fill();
                
                // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(10, 10, 8, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.stroke();
                
                // è½¬æ¢ä¸ºDataURL
                const iconUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºç™¾åº¦åœ°å›¾å›¾æ ‡
                return new BMap.Icon(iconUrl, new BMap.Size(20, 20), {
                    anchor: new BMap.Size(10, 10)
                });
            },

            // æ›´æ–°æµ‹é‡
            updateMeasurement: function() {
                const points = this.state.measurePoints;
                if (points.length < 2) return;
                
                // æ¸…é™¤ä¹‹å‰çš„çº¿å’Œé¢ç§¯
                this.clearMeasurePolylines();
                this.clearMeasurePolygon();
                
                // å°†ç‚¹è½¬æ¢ä¸ºç™¾åº¦åœ°å›¾åæ ‡
                const bmapPoints = points.map(p => new BMap.Point(p.lng, p.lat));
                
                if (this.state.measureMode === 'distance') {
                    // ç»˜åˆ¶æµ‹é‡çº¿
                    for (let i = 0; i < bmapPoints.length - 1; i++) {
                        const polyline = new BMap.Polyline([bmapPoints[i], bmapPoints[i + 1]], {
                            strokeColor: '#FF5722',
                            strokeWeight: 3,
                            strokeOpacity: 0.8,
                            strokeStyle: 'dashed'
                        });
                        this.state.map.addOverlay(polyline);
                        this.state.measurePolylines.push(polyline);
                    }
                } else if (this.state.measureMode === 'area' && points.length >= 3) {
                    // ç»˜åˆ¶æµ‹é‡é¢ç§¯
                    // é¦–å…ˆç»˜åˆ¶è¿æ¥çº¿
                    for (let i = 0; i < bmapPoints.length; i++) {
                        const nextIndex = (i + 1) % bmapPoints.length;
                        const polyline = new BMap.Polyline([bmapPoints[i], bmapPoints[nextIndex]], {
                            strokeColor: '#FF5722',
                            strokeWeight: 3,
                            strokeOpacity: 0.8,
                            strokeStyle: 'solid'
                        });
                        this.state.map.addOverlay(polyline);
                        this.state.measurePolylines.push(polyline);
                    }
                    
                    // ç»˜åˆ¶å¡«å……åŒºåŸŸ
                    this.state.measurePolygon = new BMap.Polygon(bmapPoints, {
                        strokeColor: '#FF5722',
                        strokeWeight: 2,
                        strokeOpacity: 0.8,
                        fillColor: '#FF5722',
                        fillOpacity: 0.2
                    });
                    this.state.map.addOverlay(this.state.measurePolygon);
                }
            },

            // æ›´æ–°æµ‹é‡ç»“æœæ˜¾ç¤º
            updateMeasureResults: function() {
                const resultsDiv = document.getElementById('measure-results');
                const points = this.state.measurePoints;
                
                if (points.length === 0) {
                    resultsDiv.innerHTML = '<div style="color: #888; text-align: center;">ç‚¹å‡»åœ°å›¾æ·»åŠ æµ‹é‡ç‚¹</div>';
                    return;
                }
                
                let html = '';
                
                if (this.state.measureMode === 'distance') {
                    // è·ç¦»æµ‹é‡ç»“æœ
                    let totalDistance = 0;
                    
                    for (let i = 0; i < points.length; i++) {
                        const point = points[i];
                        let segmentDistance = 0;
                        
                        if (i > 0) {
                            segmentDistance = this.calculateDistance(points[i-1], point);
                            totalDistance += segmentDistance;
                        }
                        
                        html += `
                            <div class="measure-point">
                                <span>ç‚¹ ${i+1}:</span>
                                <span>${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</span>
                            </div>
                        `;
                        
                        if (i > 0) {
                            html += `
                                <div class="measure-point" style="margin-left: 10px; font-size: 0.8rem; color: #666;">
                                    <span>â†³ æ®µ${i}:</span>
                                    <span>${this.formatDistance(segmentDistance)}</span>
                                </div>
                            `;
                        }
                    }
                    
                    if (points.length >= 2) {
                        html += `
                            <div class="measure-total">
                                <span>æ€»è·ç¦»:</span>
                                <span>${this.formatDistance(totalDistance)}</span>
                            </div>
                        `;
                    }
                } else if (this.state.measureMode === 'area') {
                    // é¢ç§¯æµ‹é‡ç»“æœ
                    for (let i = 0; i < points.length; i++) {
                        const point = points[i];
                        html += `
                            <div class="measure-point">
                                <span>ç‚¹ ${i+1}:</span>
                                <span>${point.lat.toFixed(6)}, ${point.lng.toFixed(6)}</span>
                            </div>
                        `;
                    }
                    
                    if (points.length >= 3) {
                        const area = this.calculateArea(points);
                        html += `
                            <div class="measure-total">
                                <span>æ€»é¢ç§¯:</span>
                                <span>${this.formatArea(area)}</span>
                            </div>
                        `;
                    }
                }
                
                resultsDiv.innerHTML = html;
                resultsDiv.classList.add('active');
            },

            // è®¡ç®—ä¸¤ç‚¹è·ç¦»
            calculateDistance: function(point1, point2) {
                const R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
                const lat1 = point1.lat * Math.PI / 180;
                const lat2 = point2.lat * Math.PI / 180;
                const dLat = (point2.lat - point1.lat) * Math.PI / 180;
                const dLng = (point2.lng - point1.lng) * Math.PI / 180;
                
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                         Math.cos(lat1) * Math.cos(lat2) *
                         Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            },

            // è®¡ç®—å¤šè¾¹å½¢é¢ç§¯ï¼ˆå•ä½ï¼šå¹³æ–¹ç±³ï¼‰
            calculateArea: function(points) {
                if (points.length < 3) return 0;
                
                // ä½¿ç”¨çƒé¢å¤šè¾¹å½¢é¢ç§¯å…¬å¼
                let area = 0;
                const R = 6371000; // åœ°çƒåŠå¾„ï¼Œå•ä½ï¼šç±³
                
                for (let i = 0; i < points.length; i++) {
                    const j = (i + 1) % points.length;
                    
                    const lat1 = points[i].lat * Math.PI / 180;
                    const lng1 = points[i].lng * Math.PI / 180;
                    const lat2 = points[j].lat * Math.PI / 180;
                    const lng2 = points[j].lng * Math.PI / 180;
                    
                    area += (lng2 - lng1) * (2 + Math.sin(lat1) + Math.sin(lat2));
                }
                
                area = Math.abs(area * R * R / 2);
                return area;
            },

            // æ ¼å¼åŒ–è·ç¦»æ˜¾ç¤º
            formatDistance: function(distance) {
                if (distance < 1000) {
                    return distance.toFixed(0) + ' ç±³';
                } else {
                    return (distance / 1000).toFixed(2) + ' å…¬é‡Œ';
                }
            },

            // æ ¼å¼åŒ–é¢ç§¯æ˜¾ç¤º
            formatArea: function(area) {
                if (area < 10000) {
                    return area.toFixed(2) + ' å¹³æ–¹ç±³';
                } else if (area < 1000000) {
                    return (area / 10000).toFixed(2) + ' å…¬é¡·';
                } else {
                    return (area / 1000000).toFixed(2) + ' å¹³æ–¹å…¬é‡Œ';
                }
            },

            // æ¸…é™¤æµ‹é‡çº¿å’Œé¢ç§¯
            clearMeasurePolylines: function() {
                this.state.measurePolylines.forEach(polyline => {
                    this.state.map.removeOverlay(polyline);
                });
                this.state.measurePolylines = [];
            },

            clearMeasurePolygon: function() {
                if (this.state.measurePolygon) {
                    this.state.map.removeOverlay(this.state.measurePolygon);
                    this.state.measurePolygon = null;
                }
            },

            // æ¸…é™¤æµ‹é‡ç‚¹æ ‡è®°
            clearMeasureMarkers: function() {
                this.state.measureMarkers.forEach(marker => {
                    this.state.map.removeOverlay(marker);
                });
                this.state.measureMarkers = [];
            },

            // æ¸…é™¤æ‰€æœ‰æµ‹é‡
            clearMeasurement: function() {
                this.clearMeasureMarkers();
                this.clearMeasurePolylines();
                this.clearMeasurePolygon();
                
                this.state.measurePoints = [];
                this.state.measureMode = null;
                this.state.isMeasuring = false;
                
                // è§£é™¤åœ°å›¾é”å®š
                this.unlockMap();
                
                // éšè—æµ‹é‡ç»“æœ
                const resultsDiv = document.getElementById('measure-results');
                resultsDiv.classList.remove('active');
                resultsDiv.innerHTML = '<div style="color: #888; text-align: center;">ç‚¹å‡»åœ°å›¾æ·»åŠ æµ‹é‡ç‚¹</div>';
                
                // éšè—æ¸…é™¤æŒ‰é’®
                document.getElementById('clear-measure-btn').style.display = 'none';
                
                // éšè—æµ‹é‡æ§åˆ¶é¢æ¿
                document.getElementById('measure-controls').classList.remove('active');
            },

            // å¼€å§‹æµ‹é‡
            startMeasurement: function(mode) {
                // å…ˆæ¸…é™¤ä¹‹å‰çš„æµ‹é‡
                this.clearMeasurement();
                
                this.state.measureMode = mode;
                this.state.isMeasuring = true;
                
                // é”å®šåœ°å›¾é˜²æ­¢æ‹–åŠ¨ï¼ˆä½†ä»ç„¶å…è®¸ç¼©æ”¾ï¼‰
                this.lockMapForMeasurement();
                
                // æ˜¾ç¤ºæ¸…é™¤æŒ‰é’®
                document.getElementById('clear-measure-btn').style.display = 'block';
                
                // æ˜¾ç¤ºæµ‹é‡æ§åˆ¶é¢æ¿
                document.getElementById('measure-controls').classList.add('active');
                
                // æ›´æ–°æµ‹é‡æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                if (mode === 'distance') {
                    document.getElementById('measure-distance-btn').classList.add('active');
                } else if (mode === 'area') {
                    document.getElementById('measure-area-btn').classList.add('active');
                }
            },

            // å®Œæˆæµ‹é‡
            finishMeasurement: function() {
                this.state.isMeasuring = false;
                
                // è§£é™¤åœ°å›¾é”å®š
                this.unlockMap();
                
                // éšè—æµ‹é‡æ§åˆ¶é¢æ¿
                document.getElementById('measure-controls').classList.remove('active');
                
                // æ›´æ–°æµ‹é‡æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
            },

            // æ’¤é”€ä¸Šä¸€ä¸ªç‚¹
            undoLastPoint: function() {
                if (this.state.measurePoints.length === 0) return;
                
                // ç§»é™¤æœ€åä¸€ä¸ªç‚¹
                this.state.measurePoints.pop();
                
                // æ¸…é™¤æ‰€æœ‰æµ‹é‡å›¾å½¢
                this.clearMeasureMarkers();
                this.clearMeasurePolylines();
                this.clearMeasurePolygon();
                
                // é‡æ–°åˆ›å»ºæ ‡è®°å’Œå›¾å½¢
                this.state.measurePoints.forEach((point, index) => {
                    this.createMeasureMarker(point);
                });
                
                // æ›´æ–°æµ‹é‡å›¾å½¢
                this.updateMeasurement();
                
                // æ›´æ–°æµ‹é‡ç»“æœ
                this.updateMeasureResults();
            },

            // ================== åœ°å›¾é”å®šåŠŸèƒ½ ==================
            
            // é”å®šåœ°å›¾ç”¨äºæµ‹é‡ï¼ˆåªç¦ç”¨æ‹–åŠ¨ï¼Œä½†ä»ç„¶å…è®¸ç¼©æ”¾ï¼‰- ä¿®å¤ï¼šä¿å­˜å½“å‰çŠ¶æ€
            lockMapForMeasurement: function() {
                if (!this.state.map) return;
                
                // ä¿å­˜åŸå§‹çŠ¶æ€
                this.state.mapOriginalState.enableDragging = this.state.map.enableDragging();
                this.state.mapOriginalState.enableScrollWheelZoom = this.state.map.enableScrollWheelZoom();
                this.state.mapOriginalState.enableDoubleClickZoom = this.state.map.enableDoubleClickZoom();
                this.state.mapOriginalState.enableKeyboard = this.state.map.enableKeyboard();
                
                // ç¦ç”¨åœ°å›¾æ‹–æ‹½å’Œé”®ç›˜ï¼Œä½†ä¿ç•™æ»šè½®ç¼©æ”¾å’ŒåŒå‡»ç¼©æ”¾
                this.state.map.disableDragging();
                this.state.map.disableKeyboard();
                // ä¸ç¦ç”¨æ»šè½®ç¼©æ”¾å’ŒåŒå‡»ç¼©æ”¾ï¼Œè¿™æ ·åœ¨æµ‹é‡æ—¶å¯ä»¥ç”¨æ»šè½®ç¼©æ”¾åœ°å›¾
                
                this.state.isMapLocked = true;
                
                // æ›´æ–°é”å®šæŒ‰é’®çŠ¶æ€
                const lockBtn = document.getElementById('lock-map-btn');
                if (lockBtn) {
                    lockBtn.classList.add('active');
                    lockBtn.innerHTML = 'ğŸ”“ è§£é”åœ°å›¾';
                }
                
                // æ˜¾ç¤ºé”å®šæç¤º
                this.showMapLockIndicator('åœ°å›¾å·²é”å®š<br><small>æµ‹é‡æœŸé—´åœ°å›¾ä¸å¯æ‹–åŠ¨ï¼Œä½†å¯ä»¥ç¼©æ”¾</small>');
                
                console.log('åœ°å›¾å·²é”å®šï¼ˆå¯ç¼©æ”¾ï¼‰');
            },

            // é”å®šåœ°å›¾ï¼ˆå®Œå…¨é”å®šï¼Œç¦æ­¢æ‰€æœ‰äº¤äº’ï¼‰- ä¿®å¤ï¼šä¿å­˜å½“å‰çŠ¶æ€
            lockMap: function() {
                if (!this.state.map) return;
                
                // ä¿å­˜åŸå§‹çŠ¶æ€
                this.state.mapOriginalState.enableDragging = this.state.map.enableDragging();
                this.state.mapOriginalState.enableScrollWheelZoom = this.state.map.enableScrollWheelZoom();
                this.state.mapOriginalState.enableDoubleClickZoom = this.state.map.enableDoubleClickZoom();
                this.state.mapOriginalState.enableKeyboard = this.state.map.enableKeyboard();
                
                // ç¦ç”¨æ‰€æœ‰åœ°å›¾äº¤äº’
                this.state.map.disableDragging();
                this.state.map.disableScrollWheelZoom();
                this.state.map.disableDoubleClickZoom();
                this.state.map.disableKeyboard();
                
                this.state.isMapLocked = true;
                
                // æ›´æ–°é”å®šæŒ‰é’®çŠ¶æ€
                const lockBtn = document.getElementById('lock-map-btn');
                if (lockBtn) {
                    lockBtn.classList.add('active');
                    lockBtn.innerHTML = 'ğŸ”“ è§£é”åœ°å›¾';
                }
                
                // æ˜¾ç¤ºé”å®šæç¤º
                this.showMapLockIndicator('åœ°å›¾å·²å®Œå…¨é”å®š<br><small>æ‰€æœ‰åœ°å›¾äº¤äº’å·²è¢«ç¦ç”¨</small>');
                
                console.log('åœ°å›¾å·²å®Œå…¨é”å®š');
            },

            // è§£é”åœ°å›¾ï¼ˆæ¢å¤æ‹–åŠ¨å’Œç¼©æ”¾ï¼‰- ä¿®å¤ï¼šå¯é åœ°æ¢å¤çŠ¶æ€
            unlockMap: function() {
                if (!this.state.map) return;
                
                // æ¢å¤åœ°å›¾äº¤äº’
                if (this.state.mapOriginalState.enableDragging) {
                    this.state.map.enableDragging();
                }
                if (this.state.mapOriginalState.enableScrollWheelZoom) {
                    this.state.map.enableScrollWheelZoom();
                }
                if (this.state.mapOriginalState.enableDoubleClickZoom) {
                    this.state.map.enableDoubleClickZoom();
                }
                if (this.state.mapOriginalState.enableKeyboard) {
                    this.state.map.enableKeyboard();
                }
                
                // å¦‚æœåŸå§‹çŠ¶æ€ä¿¡æ¯ä¸å…¨ï¼Œç¡®ä¿å¯ç”¨åŸºæœ¬äº¤äº’
                if (typeof this.state.mapOriginalState.enableDragging === 'undefined') {
                    this.state.map.enableDragging();
                }
                if (typeof this.state.mapOriginalState.enableScrollWheelZoom === 'undefined') {
                    this.state.map.enableScrollWheelZoom(true);
                }
                
                this.state.isMapLocked = false;
                
                // æ›´æ–°é”å®šæŒ‰é’®çŠ¶æ€
                const lockBtn = document.getElementById('lock-map-btn');
                if (lockBtn) {
                    lockBtn.classList.remove('active');
                    lockBtn.innerHTML = 'ğŸ”’ é”å®šåœ°å›¾';
                }
                
                console.log('åœ°å›¾å·²è§£é”');
            },

            // åˆ‡æ¢åœ°å›¾é”å®šçŠ¶æ€
            toggleMapLock: function() {
                if (this.state.isMapLocked) {
                    this.unlockMap();
                    this.showMapLockIndicator('åœ°å›¾å·²è§£é”<br><small>ç°åœ¨å¯ä»¥æ‹–åŠ¨å’Œç¼©æ”¾åœ°å›¾</small>');
                } else {
                    // å¦‚æœæ˜¯æµ‹é‡æ¨¡å¼ï¼Œä½¿ç”¨æµ‹é‡é”å®šï¼ˆå…è®¸ç¼©æ”¾ï¼‰
                    if (this.state.isMeasuring) {
                        this.lockMapForMeasurement();
                    } else {
                        // å¦åˆ™å®Œå…¨é”å®š
                        this.lockMap();
                    }
                }
            },

            // æ˜¾ç¤ºåœ°å›¾é”å®šæç¤º
            showMapLockIndicator: function(message) {
                const indicator = document.getElementById('map-lock-indicator');
                if (indicator) {
                    indicator.innerHTML = message;
                    indicator.classList.add('active');
                    
                    // 2ç§’åè‡ªåŠ¨éšè—
                    setTimeout(() => {
                        indicator.classList.remove('active');
                    }, 2000);
                }
            },

            // ================== æ”¹è¿›çš„å®šä½åŠŸèƒ½ ==================

            // å®šä½æˆ‘çš„ä½ç½®ï¼ˆæ”¹è¿›ç‰ˆï¼Œè§£å†³åæ ‡åç§»é—®é¢˜ï¼‰
            locateMe: function() {
                if (!this.state.map) {
                    alert('åœ°å›¾æœªåŠ è½½æˆåŠŸï¼Œæ— æ³•å®šä½');
                    return;
                }
                
                // æ˜¾ç¤ºå®šä½åŠ è½½æç¤º
                this.showLocationLoading();
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒåœ°ç†ä½ç½®API
                if (!navigator.geolocation) {
                    this.showLocationError('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
                    return;
                }
                
                // ä¼˜å…ˆä½¿ç”¨ç™¾åº¦åœ°å›¾å®šä½æœåŠ¡
                if (this.state.geolocation) {
                    this.state.geolocation.getCurrentPosition(
                        (position) => {
                            // ç™¾åº¦åœ°å›¾å®šä½æˆåŠŸï¼Œè¿”å›çš„æ˜¯ç™¾åº¦åæ ‡
                            this.handleBaiduLocationSuccess(position);
                        },
                        (error) => {
                            // ç™¾åº¦åœ°å›¾å®šä½å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
                            console.warn('ç™¾åº¦åœ°å›¾å®šä½å¤±è´¥:', error);
                            // å›é€€åˆ°æµè§ˆå™¨å®šä½
                            this.tryBrowserGeolocation();
                        },
                        {
                            enableHighAccuracy: true, // å¯ç”¨é«˜ç²¾åº¦
                            timeout: 15000, // è¶…æ—¶æ—¶é—´15ç§’
                            maximumAge: 60000 // æœ€å¤§ç¼“å­˜æ—¶é—´1åˆ†é’Ÿ
                        }
                    );
                } else {
                    // å›é€€åˆ°æµè§ˆå™¨å®šä½
                    this.tryBrowserGeolocation();
                }
            },

            // å¤„ç†ç™¾åº¦åœ°å›¾å®šä½æˆåŠŸ
            handleBaiduLocationSuccess: function(position) {
                // ç™¾åº¦åœ°å›¾å®šä½è¿”å›çš„å·²ç»æ˜¯ç™¾åº¦åæ ‡ï¼ˆBD09ï¼‰
                const point = new BMap.Point(position.point.lng, position.point.lat);
                const accuracy = position.accuracy || 20; // ç²¾åº¦ï¼Œå•ä½ï¼šç±³
                
                // ä¿å­˜å½“å‰ä½ç½®ä¿¡æ¯
                this.state.currentPosition = {
                    lng: position.point.lng,
                    lat: position.point.lat,
                    accuracy: accuracy,
                    timestamp: Date.now(),
                    isBaiduCoord: true // æ ‡è®°ä¸ºç™¾åº¦åæ ‡
                };
                
                // æ¸…é™¤ä¹‹å‰çš„å®šä½æ ‡è®°
                this.clearLocationMarker();
                
                // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå®šä½æ ‡è®°
                this.showLocationMarker(point, accuracy);
                
                // æ˜¾ç¤ºå®šä½ä¿¡æ¯é¢æ¿
                this.showLocationInfo(position.point.lat, position.point.lng, accuracy, true);
                
                // éšè—åŠ è½½æç¤º
                this.hideLocationLoading();
                
                // è‡ªåŠ¨å±…ä¸­åˆ°å½“å‰ä½ç½®
                this.centerMapOnLocation(point, accuracy);
                
                console.log('ç™¾åº¦åœ°å›¾å®šä½æˆåŠŸ:', {
                    lng: position.point.lng,
                    lat: position.point.lat,
                    accuracy: accuracy
                });
            },

            // å°è¯•æµè§ˆå™¨åŸç”Ÿå®šä½å¹¶è½¬æ¢åæ ‡
            tryBrowserGeolocation: function() {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // æµè§ˆå™¨åŸç”Ÿå®šä½æˆåŠŸ
                        this.handleBrowserLocationSuccess(position);
                    },
                    (error) => {
                        // æµè§ˆå™¨å®šä½ä¹Ÿå¤±è´¥
                        this.handleLocationError(error);
                    },
                    {
                        enableHighAccuracy: true, // å¯ç”¨é«˜ç²¾åº¦æ¨¡å¼
                        timeout: 15000, // è¶…æ—¶æ—¶é—´15ç§’
                        maximumAge: 60000, // æœ€å¤§ç¼“å­˜æ—¶é—´1åˆ†é’Ÿ
                        enableHighAccuracyPrecise: true // å¯ç”¨ç²¾ç¡®é«˜ç²¾åº¦ï¼ˆå¦‚æœæ”¯æŒï¼‰
                    }
                );
            },

            // å¤„ç†æµè§ˆå™¨åŸç”Ÿå®šä½æˆåŠŸ
            handleBrowserLocationSuccess: function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy || 50; // ç²¾åº¦ï¼Œå•ä½ï¼šç±³
                
                // ä¿å­˜WGS84åæ ‡
                this.state.currentPosition = {
                    lng: lng,
                    lat: lat,
                    accuracy: accuracy,
                    timestamp: Date.now(),
                    isBaiduCoord: false // æ ‡è®°ä¸ºWGS84åæ ‡
                };
                
                console.log('æµè§ˆå™¨å®šä½æˆåŠŸ (WGS84):', { lng, lat, accuracy });
                
                // å°†WGS84åæ ‡è½¬æ¢ä¸ºç™¾åº¦åæ ‡ï¼ˆBD09ï¼‰- ä½¿ç”¨æ”¹è¿›çš„è½¬æ¢
                this.convertWGS84ToBD09Accurate(lng, lat, (baiduPoint) => {
                    // æ¸…é™¤ä¹‹å‰çš„å®šä½æ ‡è®°
                    this.clearLocationMarker();
                    
                    // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå®šä½æ ‡è®°ï¼ˆä½¿ç”¨è½¬æ¢åçš„åæ ‡ï¼‰
                    this.showLocationMarker(baiduPoint, accuracy);
                    
                    // æ˜¾ç¤ºå®šä½ä¿¡æ¯é¢æ¿ï¼ˆæ˜¾ç¤ºåŸå§‹WGS84åæ ‡å’Œè½¬æ¢åçš„åæ ‡ï¼‰
                    this.showLocationInfoWithConversion(lat, lng, baiduPoint.lat, baiduPoint.lng, accuracy);
                    
                    // éšè—åŠ è½½æç¤º
                    this.hideLocationLoading();
                    
                    // è‡ªåŠ¨å±…ä¸­åˆ°å½“å‰ä½ç½®ï¼ˆä½¿ç”¨è½¬æ¢åçš„åæ ‡ï¼‰
                    this.centerMapOnLocation(baiduPoint, accuracy);
                });
            },

            // å°†WGS84åæ ‡è½¬æ¢ä¸ºç™¾åº¦åæ ‡ï¼ˆBD09ï¼‰- æ”¹è¿›ç‰ˆï¼Œæ›´ç²¾ç¡®
            convertWGS84ToBD09Accurate: function(lng, lat, callback) {
                const cacheKey = `${lng.toFixed(6)}_${lat.toFixed(6)}`;
                
                // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰è½¬æ¢ç»“æœ
                if (this.state.conversionCache[cacheKey]) {
                    console.log('ä½¿ç”¨ç¼“å­˜çš„åæ ‡è½¬æ¢ç»“æœ');
                    callback(this.state.conversionCache[cacheKey]);
                    return;
                }
                
                // å°è¯•ä½¿ç”¨ç™¾åº¦åœ°å›¾APIåæ ‡è½¬æ¢
                this.convertViaBaiduAPI(lng, lat, (baiduPoint) => {
                    // ç¼“å­˜è½¬æ¢ç»“æœ
                    this.state.conversionCache[cacheKey] = baiduPoint;
                    callback(baiduPoint);
                });
            },

            // é€šè¿‡ç™¾åº¦åœ°å›¾APIè½¬æ¢åæ ‡
            convertViaBaiduAPI: function(lng, lat, callback) {
                // ä½¿ç”¨ç™¾åº¦åœ°å›¾åæ ‡è½¬æ¢API
                const url = `https://api.map.baidu.com/geoconv/v1/?coords=${lng},${lat}&from=1&to=5&ak=bHbYmLEhs5ydYI1qLqIGiO1G3oSo0Vc8`;
                
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 0 && data.result && data.result.length > 0) {
                            const result = data.result[0];
                            const baiduPoint = new BMap.Point(result.x, result.y);
                            console.log('ç™¾åº¦APIåæ ‡è½¬æ¢æˆåŠŸ:', result);
                            callback(baiduPoint);
                        } else {
                            console.warn('ç™¾åº¦APIåæ ‡è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç²¾ç¡®ç®—æ³•è½¬æ¢:', data);
                            // APIè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç²¾ç¡®è½¬æ¢ç®—æ³•
                            this.convertWGS84ToBD09Precise(lng, lat, callback);
                        }
                    })
                    .catch(error => {
                        console.error('åæ ‡è½¬æ¢APIè¯·æ±‚å¤±è´¥:', error);
                        // APIè¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨ç²¾ç¡®è½¬æ¢ç®—æ³•
                        this.convertWGS84ToBD09Precise(lng, lat, callback);
                    });
            },

            // ç²¾ç¡®åæ ‡è½¬æ¢ç®—æ³•ï¼ˆç”¨äºå¹¿å·åœ°åŒºçš„WGS84è½¬ç™¾åº¦åæ ‡ï¼‰
            convertWGS84ToBD09Precise: function(lng, lat, callback) {
                // è¿™æ˜¯ä¸€ä¸ªé’ˆå¯¹å¹¿å·åœ°åŒºçš„ç²¾ç¡®è½¬æ¢ç®—æ³•
                // åŸºäºå®æµ‹æ•°æ®å’Œç™¾åº¦åœ°å›¾çš„åæ ‡è½¬æ¢è§„å¾‹
                
                // å°†WGS84åæ ‡è½¬æ¢ä¸ºGCJ-02åæ ‡ï¼ˆç«æ˜Ÿåæ ‡ï¼‰
                const gcj02 = this.wgs84ToGcj02(lng, lat);
                
                // å°†GCJ-02åæ ‡è½¬æ¢ä¸ºBD-09åæ ‡ï¼ˆç™¾åº¦åæ ‡ï¼‰
                const bd09 = this.gcj02ToBd09(gcj02.lng, gcj02.lat);
                
                console.log('ç²¾ç¡®ç®—æ³•åæ ‡è½¬æ¢:', {
                    wgs84: { lng, lat },
                    gcj02: gcj02,
                    bd09: bd09
                });
                
                callback(new BMap.Point(bd09.lng, bd09.lat));
            },

            // WGS84è½¬GCJ-02ï¼ˆç«æ˜Ÿåæ ‡ï¼‰ç®—æ³•
            wgs84ToGcj02: function(lng, lat) {
                const pi = 3.1415926535897932384626;
                const a = 6378245.0;
                const ee = 0.00669342162296594323;
                
                if (this.outOfChina(lng, lat)) {
                    return { lng: lng, lat: lat };
                }
                
                let dLat = this.transformLat(lng - 105.0, lat - 35.0);
                let dLng = this.transformLng(lng - 105.0, lat - 35.0);
                
                const radLat = lat / 180.0 * pi;
                let magic = Math.sin(radLat);
                magic = 1 - ee * magic * magic;
                const sqrtMagic = Math.sqrt(magic);
                
                dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * pi);
                dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * pi);
                
                const mgLat = lat + dLat;
                const mgLng = lng + dLng;
                
                return { lng: mgLng, lat: mgLat };
            },

            // GCJ-02è½¬BD-09ï¼ˆç™¾åº¦åæ ‡ï¼‰ç®—æ³•
            gcj02ToBd09: function(lng, lat) {
                const pi = 3.1415926535897932384626;
                const z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * pi);
                const theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * pi);
                const bdLng = z * Math.cos(theta) + 0.0065;
                const bdLat = z * Math.sin(theta) + 0.006;
                
                return { lng: bdLng, lat: bdLat };
            },

            // åˆ¤æ–­åæ ‡æ˜¯å¦åœ¨ä¸­å›½ä»¥å¤–
            outOfChina: function(lng, lat) {
                return (lng < 72.004 || lng > 137.8347) || (lat < 0.8293 || lat > 55.8271);
            },

            transformLat: function(x, y) {
                let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(y * Math.PI) + 40.0 * Math.sin(y / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (160.0 * Math.sin(y / 12.0 * Math.PI) + 320 * Math.sin(y * Math.PI / 30.0)) * 2.0 / 3.0;
                return ret;
            },

            transformLng: function(x, y) {
                let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(x * Math.PI) + 40.0 * Math.sin(x / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (150.0 * Math.sin(x / 12.0 * Math.PI) + 300.0 * Math.sin(x / 30.0 * Math.PI)) * 2.0 / 3.0;
                return ret;
            },

            // å¤„ç†å®šä½é”™è¯¯
            handleLocationError: function(error) {
                let errorMessage = 'å®šä½å¤±è´¥';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'ç”¨æˆ·æ‹’ç»äº†åœ°ç†å®šä½è¯·æ±‚ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿GPSå·²å¼€å¯';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'è·å–ä½ç½®ä¿¡æ¯è¶…æ—¶ï¼Œè¯·é‡è¯•';
                        break;
                    case error.UNKNOWN_ERROR:
                        errorMessage = 'æœªçŸ¥é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
                        break;
                }
                
                this.showLocationError(errorMessage);
                this.hideLocationLoading();
                
                console.error('å®šä½å¤±è´¥:', error);
            },

            // åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºå®šä½æ ‡è®°
            showLocationMarker: function(point, accuracy) {
                // æ¸…é™¤ä¹‹å‰çš„æ ‡è®°
                this.clearLocationMarker();
                
                // åˆ›å»ºå®šä½æ ‡è®°
                this.state.locationMarker = new BMap.Marker(point, {
                    icon: this.createLocationMarkerIcon()
                });
                
                // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
                this.state.map.addOverlay(this.state.locationMarker);
                
                // æ·»åŠ ç²¾åº¦åœˆ
                if (accuracy > 0) {
                    this.state.accuracyCircle = new BMap.Circle(point, accuracy, {
                        strokeColor: "#2196F3",
                        strokeWeight: 1,
                        strokeOpacity: 0.5,
                        fillColor: "#2196F3",
                        fillOpacity: 0.2
                    });
                    
                    this.state.map.addOverlay(this.state.accuracyCircle);
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºå®šä½ä¿¡æ¯
                this.state.locationMarker.addEventListener('click', () => {
                    if (this.state.currentPosition.isBaiduCoord) {
                        this.showLocationInfo(point.lat, point.lng, accuracy, true);
                    } else {
                        // å¦‚æœåŸå§‹åæ ‡æ˜¯WGS84ï¼Œæ˜¾ç¤ºè½¬æ¢ä¿¡æ¯
                        this.showLocationInfoWithConversion(
                            this.state.currentPosition.lat, 
                            this.state.currentPosition.lng,
                            point.lat,
                            point.lng,
                            accuracy
                        );
                    }
                });
            },

            // åˆ›å»ºå®šä½æ ‡è®°å›¾æ ‡
            createLocationMarkerIcon: function() {
                // ä½¿ç”¨Canvasåˆ›å»ºå›¾æ ‡
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶å¤–åœˆ
                ctx.beginPath();
                ctx.arc(16, 16, 12, 0, Math.PI * 2);
                ctx.fillStyle = '#2196F3';
                ctx.fill();
                
                // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(16, 16, 12, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.stroke();
                
                // ç»˜åˆ¶å†…åœˆ
                ctx.beginPath();
                ctx.arc(16, 16, 8, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                // ç»˜åˆ¶ä¸­å¿ƒç‚¹
                ctx.beginPath();
                ctx.arc(16, 16, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#2196F3';
                ctx.fill();
                
                // è½¬æ¢ä¸ºDataURL
                const iconUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºç™¾åº¦åœ°å›¾å›¾æ ‡
                return new BMap.Icon(iconUrl, new BMap.Size(32, 32), {
                    anchor: new BMap.Size(16, 16)
                });
            },

            // æ¸…é™¤å®šä½æ ‡è®°
            clearLocationMarker: function() {
                if (this.state.locationMarker) {
                    this.state.map.removeOverlay(this.state.locationMarker);
                    this.state.locationMarker = null;
                }
                
                if (this.state.accuracyCircle) {
                    this.state.map.removeOverlay(this.state.accuracyCircle);
                    this.state.accuracyCircle = null;
                }
            },

            // æ˜¾ç¤ºå®šä½ä¿¡æ¯é¢æ¿ï¼ˆæ™®é€šç‰ˆï¼‰
            showLocationInfo: function(lat, lng, accuracy, isBaiduCoord) {
                // æ›´æ–°ä½ç½®ä¿¡æ¯
                document.getElementById('location-lat').textContent = lat.toFixed(6);
                document.getElementById('location-lng').textContent = lng.toFixed(6);
                
                if (accuracy) {
                    document.getElementById('location-accuracy').textContent = `ç²¾åº¦: ${accuracy.toFixed(0)} ç±³`;
                    if (accuracy < 10) {
                        document.getElementById('location-accuracy').innerHTML += ' <span style="color: #4CAF50;">(é«˜ç²¾åº¦)</span>';
                    } else if (accuracy < 50) {
                        document.getElementById('location-accuracy').innerHTML += ' <span style="color: #FF9800;">(ä¸­ç­‰ç²¾åº¦)</span>';
                    } else {
                        document.getElementById('location-accuracy').innerHTML += ' <span style="color: #F44336;">(ä½ç²¾åº¦)</span>';
                    }
                    
                    // æ·»åŠ åæ ‡ç±»å‹è¯´æ˜
                    if (isBaiduCoord) {
                        document.getElementById('location-accuracy').innerHTML += '<br><small style="color: #888; font-size: 0.75rem;">ç™¾åº¦åœ°å›¾å®šä½ (BD09åæ ‡ç³»)</small>';
                    }
                } else {
                    document.getElementById('location-accuracy').textContent = 'ç²¾åº¦: æœªçŸ¥';
                }
                
                // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                document.getElementById('location-info').style.display = 'block';
                
                // æ˜¾ç¤ºå®šä½é¢æ¿
                document.getElementById('location-panel').classList.add('active');
                
                // éšè—é”™è¯¯ä¿¡æ¯
                this.hideLocationError();
            },

            // æ˜¾ç¤ºå®šä½ä¿¡æ¯é¢æ¿ï¼ˆå¸¦åæ ‡è½¬æ¢ä¿¡æ¯ï¼‰
            showLocationInfoWithConversion: function(originalLat, originalLng, baiduLat, baiduLng, accuracy) {
                // æ›´æ–°ä½ç½®ä¿¡æ¯
                document.getElementById('location-lat').textContent = originalLat.toFixed(6);
                document.getElementById('location-lng').textContent = originalLng.toFixed(6);
                
                // è®¡ç®—åæ ‡è½¬æ¢è¯¯å·®
                const latDiff = Math.abs(baiduLat - originalLat) * 111000; // çº¬åº¦å·®è½¬æ¢ä¸ºç±³
                const lngDiff = Math.abs(baiduLng - originalLng) * 111000 * Math.cos(originalLat * Math.PI / 180);
                const totalError = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
                
                // æ·»åŠ åæ ‡è½¬æ¢è¯´æ˜
                const accuracyElement = document.getElementById('location-accuracy');
                if (accuracy) {
                    accuracyElement.innerHTML = `
                        ç²¾åº¦: ${accuracy.toFixed(0)} ç±³<br>
                        <small style="color: #888; font-size: 0.75rem;">
                            åŸå§‹åæ ‡(WGS84): ${originalLat.toFixed(6)}, ${originalLng.toFixed(6)}<br>
                            è½¬æ¢åæ ‡(BD09): ${baiduLat.toFixed(6)}, ${baiduLng.toFixed(6)}<br>
                            åæ ‡è½¬æ¢è¯¯å·®: ${totalError.toFixed(1)} ç±³
                        </small>
                    `;
                    
                    if (accuracy < 10) {
                        accuracyElement.innerHTML += ' <span style="color: #4CAF50;">(é«˜ç²¾åº¦)</span>';
                    } else if (accuracy < 50) {
                        accuracyElement.innerHTML += ' <span style="color: #FF9800;">(ä¸­ç­‰ç²¾åº¦)</span>';
                    } else {
                        accuracyElement.innerHTML += ' <span style="color: #F44336;">(ä½ç²¾åº¦)</span>';
                    }
                } else {
                    accuracyElement.innerHTML = `
                        ç²¾åº¦: æœªçŸ¥<br>
                        <small style="color: #888; font-size: 0.75rem;">
                            åŸå§‹åæ ‡(WGS84): ${originalLat.toFixed(6)}, ${originalLng.toFixed(6)}<br>
                            è½¬æ¢åæ ‡(BD09): ${baiduLat.toFixed(6)}, ${baiduLng.toFixed(6)}<br>
                            åæ ‡è½¬æ¢è¯¯å·®: ${totalError.toFixed(1)} ç±³
                        </small>
                    `;
                }
                
                // æ˜¾ç¤ºä½ç½®ä¿¡æ¯
                document.getElementById('location-info').style.display = 'block';
                
                // æ˜¾ç¤ºå®šä½é¢æ¿
                document.getElementById('location-panel').classList.add('active');
                
                // éšè—é”™è¯¯ä¿¡æ¯
                this.hideLocationError();
            },

            // éšè—å®šä½ä¿¡æ¯é¢æ¿
            hideLocationInfo: function() {
                document.getElementById('location-panel').classList.remove('active');
            },

            // æ˜¾ç¤ºå®šä½åŠ è½½æç¤º
            showLocationLoading: function() {
                document.getElementById('location-loading').classList.add('active');
                document.getElementById('location-info').style.display = 'none';
                this.hideLocationError();
            },

            // éšè—å®šä½åŠ è½½æç¤º
            hideLocationLoading: function() {
                document.getElementById('location-loading').classList.remove('active');
            },

            // æ˜¾ç¤ºå®šä½é”™è¯¯
            showLocationError: function(message) {
                document.getElementById('location-error').textContent = message;
                document.getElementById('location-error').classList.add('active');
                document.getElementById('location-info').style.display = 'none';
            },

            // éšè—å®šä½é”™è¯¯
            hideLocationError: function() {
                document.getElementById('location-error').classList.remove('active');
            },

            // å°†åœ°å›¾å±…ä¸­åˆ°å®šä½ä½ç½®
            centerMapOnLocation: function(point, accuracy) {
                if (!this.state.map) return;
                
                // è®¡ç®—åˆé€‚çš„ç¼©æ”¾çº§åˆ«
                let zoomLevel = 17; // é»˜è®¤æ›´è¿‘ä¸€äº›
                if (accuracy > 100) {
                    zoomLevel = 16;
                } else if (accuracy > 200) {
                    zoomLevel = 15;
                } else if (accuracy > 500) {
                    zoomLevel = 14;
                }
                
                // å±…ä¸­åœ°å›¾
                this.state.map.centerAndZoom(point, zoomLevel);
                
                // æ·»åŠ ä¸€ä¸ªå¹³æ»‘ç§»åŠ¨çš„åŠ¨ç”»
                this.state.map.panTo(point);
            },

            // å°†å½“å‰ä½ç½®è®¾ä¸ºè·¯å¾„èµ·ç‚¹
            setCurrentLocationAsStart: function() {
                if (!this.state.currentPosition) {
                    alert('è¯·å…ˆè·å–æ‚¨çš„ä½ç½®');
                    return;
                }
                
                document.getElementById('route-start').value = 'current_location';
                document.getElementById('navigation-panel').classList.add('active');
                this.state.navigationVisible = true;
                this.hideLocationInfo();
            },

            // å°†å½“å‰ä½ç½®è®¾ä¸ºè·¯å¾„ç»ˆç‚¹
            setCurrentLocationAsEnd: function() {
                if (!this.state.currentPosition) {
                    alert('è¯·å…ˆè·å–æ‚¨çš„ä½ç½®');
                    return;
                }
                
                document.getElementById('route-end').value = 'current_location';
                document.getElementById('navigation-panel').classList.add('active');
                this.state.navigationVisible = true;
                this.hideLocationInfo();
            },

            // ================== å…¶ä»–åŠŸèƒ½ ==================

            // åœ°å›¾æ ‡è®°åŠŸèƒ½
            createMarkers: function() {
                if (!this.state.map) return;
                
                this.state.markers = [];
                
                // åˆ›å»ºæ–°æ ‡è®°
                this.state.buildings.forEach(building => {
                    this.createMarker(building);
                });
            },

            // åˆ›å»ºå•ä¸ªæ ‡è®°
            createMarker: function(building) {
                if (!this.state.map) return;
                
                const point = new BMap.Point(building.lng, building.lat);
                const marker = new BMap.Marker(point);
                
                // è®¾ç½®æ ‡è®°æ ·å¼
                marker.setIcon(this.createCustomIcon(building));
                
                // æ·»åŠ æ ‡è®°åˆ°åœ°å›¾
                this.state.map.addOverlay(marker);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                marker.addEventListener('click', () => {
                    this.showBuildingDetail(building.id);
                    this.centerMapOnBuilding(building);
                    this.showHighlightLabel(building);
                });
                
                // å­˜å‚¨æ ‡è®°å¼•ç”¨
                this.state.markers.push({
                    id: building.id,
                    marker: marker,
                    building: building,
                    originalIcon: marker.getIcon()
                });
            },

            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡
            createCustomIcon: function(building) {
                const cacheKey = `${building.color}_${building.id}`;
                
                // æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰è¿™ä¸ªå›¾æ ‡
                if (this.state.iconCache[cacheKey]) {
                    return this.state.iconCache[cacheKey];
                }
                
                // åˆ›å»ºCanvasæ¥ç»˜åˆ¶è‡ªå®šä¹‰å›¾æ ‡
                const canvas = document.createElement('canvas');
                canvas.width = 24;
                canvas.height = 24;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯
                ctx.beginPath();
                ctx.arc(12, 12, 10, 0, Math.PI * 2);
                ctx.fillStyle = building.color;
                ctx.fill();
                
                // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(12, 12, 10, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.stroke();
                
                // ç»˜åˆ¶å»ºç­‘ç¼–å·
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(building.id.toString(), 12, 12);
                
                // å°†Canvasè½¬æ¢ä¸ºDataURL
                const iconUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºå›¾æ ‡
                const iconSize = new BMap.Size(24, 24);
                const icon = new BMap.Icon(iconUrl, iconSize, {
                    anchor: new BMap.Size(12, 12)
                });
                
                // ç¼“å­˜å›¾æ ‡
                this.state.iconCache[cacheKey] = icon;
                
                return icon;
            },

            // åˆ›å»ºçªå‡ºæ˜¾ç¤ºå›¾æ ‡
            createHighlightIcon: function(building) {
                // åˆ›å»ºCanvasæ¥ç»˜åˆ¶çªå‡ºæ˜¾ç¤ºå›¾æ ‡
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶æ›´å¤§çš„åœ†å½¢èƒŒæ™¯
                ctx.beginPath();
                ctx.arc(16, 16, 14, 0, Math.PI * 2);
                ctx.fillStyle = building.color;
                ctx.fill();
                
                // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(16, 16, 14, 0, Math.PI * 2);
                ctx.lineWidth = 3;
                ctx.strokeStyle = 'white';
                ctx.stroke();
                
                // ç»˜åˆ¶é»„è‰²å¤–å‘å…‰
                ctx.beginPath();
                ctx.arc(16, 16, 16, 0, Math.PI * 2);
                ctx.lineWidth = 4;
                ctx.strokeStyle = '#FFD700';
                ctx.stroke();
                
                // ç»˜åˆ¶å»ºç­‘ç¼–å·
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(building.id.toString(), 16, 16);
                
                // å°†Canvasè½¬æ¢ä¸ºDataURL
                const iconUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºå›¾æ ‡
                const iconSize = new BMap.Size(32, 32);
                const icon = new BMap.Icon(iconUrl, iconSize, {
                    anchor: new BMap.Size(16, 16)
                });
                
                return icon;
            },

            // æ˜¾ç¤ºçªå‡ºæ ‡ç­¾
            showHighlightLabel: function(building) {
                const label = this.state.highlightLabel;
                label.textContent = building.name;
                label.style.display = 'block';
                
                // å°†åœ°å›¾åæ ‡è½¬æ¢ä¸ºåƒç´ åæ ‡
                const point = new BMap.Point(building.lng, building.lat);
                const pixel = this.state.map.pointToOverlayPixel(point);
                
                // è®¾ç½®æ ‡ç­¾ä½ç½®
                label.style.left = (pixel.x - label.offsetWidth / 2) + 'px';
                label.style.top = (pixel.y - label.offsetHeight - 40) + 'px';
                
                // 3ç§’åè‡ªåŠ¨éšè—æ ‡ç­¾
                clearTimeout(this.state.highlightTimeout);
                this.state.highlightTimeout = setTimeout(() => {
                    label.style.display = 'none';
                }, 3000);
            },

            // éšè—çªå‡ºæ ‡ç­¾
            hideHighlightLabel: function() {
                const label = this.state.highlightLabel;
                label.style.display = 'none';
                clearTimeout(this.state.highlightTimeout);
            },

            // é«˜äº®æ˜¾ç¤ºæ ‡è®°
            highlightMarker: function(buildingId) {
                // å¦‚æœä¹‹å‰æœ‰é«˜äº®çš„æ ‡è®°ï¼Œå…ˆæ¢å¤
                if (this.state.highlightedMarker) {
                    const prevMarkerData = this.state.markers.find(m => m.id === this.state.highlightedMarker);
                    if (prevMarkerData && prevMarkerData.originalIcon) {
                        prevMarkerData.marker.setIcon(prevMarkerData.originalIcon);
                    }
                }
                
                // é«˜äº®å½“å‰æ ‡è®°
                const markerData = this.state.markers.find(m => m.id === buildingId);
                if (markerData) {
                    const building = markerData.building;
                    const highlightIcon = this.createHighlightIcon(building);
                    markerData.marker.setIcon(highlightIcon);
                    this.state.highlightedMarker = buildingId;
                }
            },

            // æ¢å¤æ ‡è®°åŸå§‹æ ·å¼
            restoreMarker: function() {
                if (this.state.highlightedMarker) {
                    const markerData = this.state.markers.find(m => m.id === this.state.highlightedMarker);
                    if (markerData && markerData.originalIcon) {
                        markerData.marker.setIcon(markerData.originalIcon);
                    }
                    this.state.highlightedMarker = null;
                }
            },

            // ================== UIåˆå§‹åŒ– ==================

            // åˆå§‹åŒ–UIäº‹ä»¶ - ä¿®å¤ï¼šç¡®ä¿åˆå§‹åŒ–æ—¶åœ°å›¾çŠ¶æ€æ­£ç¡®
            initUI: function() {
                // ä¾§è¾¹æ åˆ‡æ¢
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    const sidebar = document.querySelector('.sidebar');
                    const icon = document.getElementById('toggle-icon');
                    sidebar.classList.toggle('hidden');
                    
                    icon.textContent = sidebar.classList.contains('hidden') ? 'â–¶' : 'â—€';
                });

                // åœ°å›¾æ§åˆ¶æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆï¼Œå¸¦æ–‡å­—ï¼‰
                document.getElementById('zoom-in').addEventListener('click', () => {
                    if (this.state.map) {
                        this.state.map.zoomIn();
                    }
                });

                document.getElementById('zoom-out').addEventListener('click', () => {
                    if (this.state.map) {
                        this.state.map.zoomOut();
                    }
                });

                document.getElementById('reset-view').addEventListener('click', () => {
                    if (this.state.map) {
                        const point = new BMap.Point(113.363727, 23.158383);
                        this.state.map.centerAndZoom(point, 16);
                        // é‡ç½®æ—¶ä¹Ÿç¡®ä¿åœ°å›¾è§£é”
                        this.ensureMapUnlocked();
                    }
                });

                document.getElementById('toggle-legend').addEventListener('click', () => {
                    const legend = document.getElementById('legend');
                    this.state.legendVisible = !this.state.legendVisible;
                    legend.style.display = this.state.legendVisible ? 'block' : 'none';
                });

                // è·¯å¾„è§„åˆ’åˆ‡æ¢
                document.getElementById('toggle-navigation').addEventListener('click', () => {
                    const navPanel = document.getElementById('navigation-panel');
                    navPanel.classList.toggle('active');
                    this.state.navigationVisible = navPanel.classList.contains('active');
                });

                // æµ‹é‡å·¥å…·åˆ‡æ¢
                document.getElementById('toggle-measure').addEventListener('click', () => {
                    // å¦‚æœæ­£åœ¨æµ‹é‡ï¼Œå…ˆå®Œæˆæµ‹é‡
                    if (this.state.isMeasuring) {
                        this.finishMeasurement();
                    }
                    
                    // æ˜¾ç¤ºæµ‹é‡å·¥å…·éƒ¨åˆ†
                    const toolsSection = document.querySelector('.tools-section');
                    toolsSection.scrollIntoView({ behavior: 'smooth' });
                });

                // å…³é—­è·¯å¾„è§„åˆ’é¢æ¿
                document.getElementById('close-navigation').addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‹–åŠ¨
                    document.getElementById('navigation-panel').classList.remove('active');
                    this.state.navigationVisible = false;
                });

                // åœ°å›¾ç±»å‹é€‰æ‹©
                document.querySelectorAll('.map-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (!this.state.map) return;
                        
                        const type = e.currentTarget.dataset.type;
                        this.changeMapType(type);
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        document.querySelectorAll('.map-type-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        e.currentTarget.classList.add('active');
                    });
                });

                // æœç´¢åŠŸèƒ½
                document.getElementById('search-input').addEventListener('input', (e) => {
                    this.performSearch(e.target.value);
                });

                // è·¯å¾„è§„åˆ’åŠŸèƒ½
                document.getElementById('plan-route-btn').addEventListener('click', () => {
                    this.planRoute();
                });
                
                document.getElementById('clear-route-btn').addEventListener('click', () => {
                    this.clearRoute();
                });

                // æµ‹é‡å·¥å…·åŠŸèƒ½
                document.getElementById('measure-distance-btn').addEventListener('click', () => {
                    this.startMeasurement('distance');
                });
                
                document.getElementById('measure-area-btn').addEventListener('click', () => {
                    this.startMeasurement('area');
                });
                
                document.getElementById('clear-measure-btn').addEventListener('click', () => {
                    this.clearMeasurement();
                });
                
                // æµ‹é‡æ§åˆ¶æŒ‰é’®
                document.getElementById('finish-measure-btn').addEventListener('click', () => {
                    this.finishMeasurement();
                });
                
                document.getElementById('cancel-measure-btn').addEventListener('click', () => {
                    this.clearMeasurement();
                });
                
                document.getElementById('undo-last-point-btn').addEventListener('click', () => {
                    this.undoLastPoint();
                });
                
                // å…³é—­æµ‹é‡æ§åˆ¶é¢æ¿æŒ‰é’®
                document.getElementById('close-measure-controls').addEventListener('click', () => {
                    document.getElementById('measure-controls').classList.remove('active');
                });

                // è·¯çº¿å¯¼èˆªæ§åˆ¶æŒ‰é’®
                document.getElementById('prev-step-btn').addEventListener('click', () => {
                    this.navigateToPrevStep();
                });
                
                document.getElementById('next-step-btn').addEventListener('click', () => {
                    this.navigateToNextStep();
                });

                // ç‚¹å‡»å»ºç­‘åˆ—è¡¨é¡¹æ—¶ï¼Œæ˜¾ç¤ºå»ºç­‘è¯¦æƒ…ï¼Œå±…ä¸­åœ°å›¾ï¼Œå¹¶æ˜¾ç¤ºçªå‡ºæ ‡ç­¾
                document.getElementById('buildings-list').addEventListener('click', (e) => {
                    const buildingItem = e.target.closest('.building-item');
                    if (buildingItem) {
                        const buildingName = buildingItem.querySelector('.building-name').textContent;
                        const building = this.state.buildings.find(b => b.name === buildingName);
                        
                        if (building) {
                            // æ˜¾ç¤ºå»ºç­‘è¯¦æƒ…é¢æ¿
                            this.showBuildingDetail(building.id);
                            // å±…ä¸­åœ°å›¾åˆ°è¯¥å»ºç­‘
                            this.centerMapOnBuilding(building);
                            // æ˜¾ç¤ºçªå‡ºæ ‡ç­¾
                            this.showHighlightLabel(building);
                            // é«˜äº®æ ‡è®°
                            this.highlightMarker(building.id);
                        }
                    }
                });

                // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹æ—¶éšè—çªå‡ºæ ‡ç­¾
                if (this.state.map) {
                    this.state.map.addEventListener('click', (e) => {
                        // åªæœ‰åœ¨æ²¡æœ‰æ­£åœ¨æµ‹é‡æ—¶æ‰éšè—çªå‡ºæ ‡ç­¾
                        if (!this.state.isMeasuring) {
                            this.hideHighlightLabel();
                        }
                    });
                }
                
                // åœ°å›¾é”å®šæŒ‰é’®
                document.getElementById('lock-map-btn').addEventListener('click', () => {
                    this.toggleMapLock();
                });
                
                // ================== å®šä½åŠŸèƒ½UIäº‹ä»¶ ==================
                
                // å®šä½æŒ‰é’®ï¼ˆæ”¹è¿›ç‰ˆï¼Œå¸¦æ–‡å­—ï¼‰
                document.getElementById('locate-me-btn').addEventListener('click', () => {
                    this.locateMe();
                });
                
                // å…³é—­å®šä½é¢æ¿æŒ‰é’®
                document.getElementById('close-location-panel').addEventListener('click', () => {
                    this.hideLocationInfo();
                });
                
                // å®šä½é¢æ¿æ“ä½œæŒ‰é’®
                document.getElementById('center-on-location').addEventListener('click', () => {
                    if (this.state.currentPosition) {
                        let point;
                        if (this.state.currentPosition.isBaiduCoord) {
                            point = new BMap.Point(this.state.currentPosition.lng, this.state.currentPosition.lat);
                        } else {
                            // å¦‚æœæ˜¯WGS84åæ ‡ï¼Œéœ€è¦è½¬æ¢
                            this.convertWGS84ToBD09Accurate(
                                this.state.currentPosition.lng, 
                                this.state.currentPosition.lat, 
                                (baiduPoint) => {
                                    this.centerMapOnLocation(baiduPoint, this.state.currentPosition.accuracy);
                                }
                            );
                            return;
                        }
                        this.centerMapOnLocation(point, this.state.currentPosition.accuracy);
                    }
                });
                
                document.getElementById('set-as-start-from-location').addEventListener('click', () => {
                    this.setCurrentLocationAsStart();
                });
                
                document.getElementById('set-as-end-from-location').addEventListener('click', () => {
                    this.setCurrentLocationAsEnd();
                });
                
                // åˆå§‹åŒ–é¢æ¿æ‹–åŠ¨åŠŸèƒ½
                this.initPanelDrag();
                
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œå†æ¬¡ç¡®ä¿åœ°å›¾è§£é”
                setTimeout(() => {
                    this.ensureMapUnlocked();
                }, 500);
            },

            // é¢æ¿æ‹–åŠ¨åŠŸèƒ½
            initPanelDrag: function() {
                const navPanel = document.getElementById('navigation-panel');
                const navHeader = document.querySelector('.navigation-header');
                
                // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶ - å¼€å§‹æ‹–åŠ¨
                navHeader.addEventListener('mousedown', (e) => {
                    // åªæœ‰å½“ç‚¹å‡»æ ‡é¢˜åŒºåŸŸä¸”ä¸æ˜¯å…³é—­æŒ‰é’®æ—¶æ‰æ‹–åŠ¨
                    if (e.target.closest('.close-btn')) return;
                    
                    this.startDrag(e, navPanel);
                });
                
                navHeader.addEventListener('touchstart', (e) => {
                    if (e.target.closest('.close-btn')) return;
                    this.startDrag(e, navPanel);
                });
                
                // æ·»åŠ å»ºç­‘è¯¦æƒ…é¢æ¿æ‹–åŠ¨
                const detailPanel = document.getElementById('building-detail');
                const detailHeader = document.querySelector('.detail-header');
                
                if (detailHeader) {
                    detailHeader.addEventListener('mousedown', (e) => {
                        if (e.target.closest('.close-detail')) return;
                        this.startDrag(e, detailPanel);
                    });
                    
                    detailHeader.addEventListener('touchstart', (e) => {
                        if (e.target.closest('.close-detail')) return;
                        this.startDrag(e, detailPanel);
                    });
                }
                
                // æ·»åŠ å®šä½é¢æ¿æ‹–åŠ¨
                const locationPanel = document.getElementById('location-panel');
                const locationHeader = document.querySelector('.location-header');
                
                if (locationHeader) {
                    locationHeader.addEventListener('mousedown', (e) => {
                        if (e.target.closest('.location-close-btn')) return;
                        this.startDrag(e, locationPanel);
                    });
                    
                    locationHeader.addEventListener('touchstart', (e) => {
                        if (e.target.closest('.location-close-btn')) return;
                        this.startDrag(e, locationPanel);
                    });
                }
                
                // æ·»åŠ æµ‹é‡æ§åˆ¶é¢æ¿æ‹–åŠ¨
                const measurePanel = document.getElementById('measure-controls');
                const measureHeader = document.querySelector('.measure-controls-header');
                
                if (measureHeader) {
                    measureHeader.addEventListener('mousedown', (e) => {
                        if (e.target.closest('.location-close-btn')) return;
                        this.startDrag(e, measurePanel);
                    });
                    
                    measureHeader.addEventListener('touchstart', (e) => {
                        if (e.target.closest('.location-close-btn')) return;
                        this.startDrag(e, measurePanel);
                    });
                }
            },

            // å¼€å§‹æ‹–åŠ¨
            startDrag: function(e, panel) {
                this.state.isDragging = true;
                this.state.dragElement = panel;
                
                // è·å–é¢æ¿å½“å‰ä½ç½®
                const rect = panel.getBoundingClientRect();
                
                // è®¡ç®—é¼ æ ‡ç›¸å¯¹äºé¢æ¿å·¦ä¸Šè§’çš„åç§»
                if (e.type === 'mousedown') {
                    this.state.dragOffset = {
                        x: e.clientX - rect.left,
                        y: e.clientY - rect.top
                    };
                } else if (e.type === 'touchstart') {
                    const touch = e.touches[0];
                    this.state.dragOffset = {
                        x: touch.clientX - rect.left,
                        y: touch.clientY - rect.top
                    };
                }
                
                // æ·»åŠ å…¨å±€é¼ æ ‡/è§¦æ‘¸ç§»åŠ¨å’Œæ¾å¼€äº‹ä»¶
                document.addEventListener('mousemove', this.handleDragMove.bind(this));
                document.addEventListener('mouseup', this.handleDragEnd.bind(this));
                document.addEventListener('touchmove', this.handleDragMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleDragEnd.bind(this));
                
                // é˜»æ­¢é»˜è®¤è¡Œä¸º
                e.preventDefault();
                e.stopPropagation();
            },

            // å¤„ç†æ‹–åŠ¨ç§»åŠ¨
            handleDragMove: function(e) {
                if (!this.state.isDragging || !this.state.dragElement) return;
                
                e.preventDefault();
                
                let clientX, clientY;
                
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else if (e.type === 'touchmove') {
                    const touch = e.touches[0];
                    clientX = touch.clientX;
                    clientY = touch.clientY;
                }
                
                // è®¡ç®—æ–°ä½ç½®
                const panel = this.state.dragElement;
                const newX = clientX - this.state.dragOffset.x;
                const newY = clientY - this.state.dragOffset.y;
                
                // ç¡®ä¿é¢æ¿ä¸ä¼šç§»å‡ºè§†å£
                const maxX = window.innerWidth - panel.offsetWidth;
                const maxY = window.innerHeight - panel.offsetHeight;
                
                // è®¾ç½®æ–°ä½ç½®
                panel.style.left = Math.max(0, Math.min(newX, maxX)) + 'px';
                panel.style.top = Math.max(0, Math.min(newY, maxY)) + 'px';
                
                // ç§»é™¤åŸæ¥çš„ä½ç½®æ ·å¼
                panel.style.right = 'auto';
                panel.style.bottom = 'auto';
            },

            // ç»“æŸæ‹–åŠ¨
            handleDragEnd: function() {
                this.state.isDragging = false;
                this.state.dragElement = null;
                
                // ç§»é™¤äº‹ä»¶ç›‘å¬
                document.removeEventListener('mousemove', this.handleDragMove);
                document.removeEventListener('mouseup', this.handleDragEnd);
                document.removeEventListener('touchmove', this.handleDragMove);
                document.removeEventListener('touchend', this.handleDragEnd);
            },

            // æ”¹å˜åœ°å›¾ç±»å‹
            changeMapType: function(type) {
                if (!this.state.map) return;
                
                switch(type) {
                    case 'normal':
                        this.state.map.setMapType(BMAP_NORMAL_MAP);
                        break;
                    case 'satellite':
                        this.state.map.setMapType(BMAP_SATELLITE_MAP);
                        break;
                    case 'hybrid':
                        this.state.map.setMapType(BMAP_HYBRID_MAP);
                        break;
                }
            },

            // ================== å…¶ä»–åŠŸèƒ½ ==================

            // æœç´¢åŠŸèƒ½
            performSearch: function(searchTerm) {
                if (!searchTerm.trim()) {
                    // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ¢å¤æŒ‰ç±»åˆ«ç­›é€‰
                    this.filterBuildingsByCategory(this.state.activeCategory);
                    return;
                }
                
                const term = searchTerm.toLowerCase();
                const filteredBuildings = this.state.buildings.filter(building => {
                    return building.name.toLowerCase().includes(term) || 
                           building.description.toLowerCase().includes(term) ||
                           building.category.toLowerCase().includes(term);
                });
                
                // æ›´æ–°å»ºç­‘åˆ—è¡¨
                this.renderBuildingsList(filteredBuildings);
                
                // æ›´æ–°åœ°å›¾æ ‡è®°å¯è§æ€§
                this.state.markers.forEach(markerData => {
                    const building = markerData.building;
                    const visible = building.name.toLowerCase().includes(term) || 
                                   building.description.toLowerCase().includes(term) ||
                                   building.category.toLowerCase().includes(term);
                                   
                    if (visible && this.state.map) {
                        markerData.marker.show();
                    } else if (this.state.map) {
                        markerData.marker.hide();
                    }
                });
            },

            // æ¸²æŸ“ç±»åˆ«ç­›é€‰å™¨
            renderCategoryFilter: function() {
                const filterContainer = document.getElementById('category-filter');
                filterContainer.innerHTML = '';

                // æ·»åŠ "å…¨éƒ¨"é€‰é¡¹
                const allButton = document.createElement('button');
                allButton.className = 'category-btn active';
                allButton.innerHTML = 'å…¨éƒ¨ (' + this.state.buildings.length + ')';
                allButton.dataset.category = 'all';
                allButton.addEventListener('click', () => {
                    this.setActiveCategory('all');
                });
                filterContainer.appendChild(allButton);

                // æ·»åŠ å…¶ä»–ç±»åˆ«
                Object.keys(this.categoryConfig).forEach(category => {
                    // è®¡ç®—è¯¥ç±»åˆ«ä¸‹çš„å»ºç­‘æ•°é‡
                    const count = this.state.buildings.filter(b => b.category === category).length;
                    
                    const button = document.createElement('button');
                    button.className = 'category-btn';
                    button.innerHTML = `${this.categoryConfig[category].icon} ${category} (${count})`;
                    button.dataset.category = category;
                    button.addEventListener('click', () => {
                        this.setActiveCategory(category);
                    });
                    filterContainer.appendChild(button);
                });
            },

            // è®¾ç½®æ´»åŠ¨ç±»åˆ«
            setActiveCategory: function(category) {
                this.state.activeCategory = category;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.category === category) {
                        btn.classList.add('active');
                    }
                });

                // ç­›é€‰å»ºç­‘
                this.filterBuildingsByCategory(category);
            },

            // æŒ‰ç±»åˆ«ç­›é€‰å»ºç­‘
            filterBuildingsByCategory: function(category) {
                let filteredBuildings = this.state.buildings;
                
                if (category !== 'all') {
                    filteredBuildings = this.state.buildings.filter(building => building.category === category);
                }
                
                // æ›´æ–°å»ºç­‘åˆ—è¡¨
                this.renderBuildingsList(filteredBuildings);
                
                // æ›´æ–°åœ°å›¾æ ‡è®°å¯è§æ€§
                this.updateMarkersVisibility(category);
            },

            // æ›´æ–°æ ‡è®°å¯è§æ€§
            updateMarkersVisibility: function(category) {
                this.state.markers.forEach(markerData => {
                    const visible = category === 'all' || markerData.building.category === category;
                    if (visible && this.state.map) {
                        markerData.marker.show();
                    } else if (this.state.map) {
                        markerData.marker.hide();
                    }
                });
            },

            // æ¸²æŸ“å»ºç­‘åˆ—è¡¨
            renderBuildingsList: function(buildings) {
                const listContainer = document.getElementById('buildings-list');
                listContainer.innerHTML = '';

                if (buildings.length === 0) {
                    listContainer.innerHTML = '<div class="building-item" style="text-align: center; color: #888;">æœªæ‰¾åˆ°åŒ¹é…çš„å»ºç­‘</div>';
                    return;
                }

                buildings.forEach(building => {
                    const item = document.createElement('div');
                    item.className = 'building-item';
                    if (building.id === this.state.activeBuildingId) {
                        item.classList.add('active');
                    }
                    
                    item.innerHTML = `
                        <div class="building-item-header">
                            <div class="building-name">${building.name}</div>
                            <div class="building-category">${building.category}</div>
                        </div>
                        <div class="building-description">${building.description}</div>
                    `;
                    
                    item.addEventListener('click', () => {
                        this.showBuildingDetail(building.id);
                        this.centerMapOnBuilding(building);
                        this.showHighlightLabel(building);
                        this.highlightMarker(building.id);
                    });
                    
                    listContainer.appendChild(item);
                });
            },

            // æ˜¾ç¤ºå»ºç­‘è¯¦æƒ…
            showBuildingDetail: function(buildingId) {
                const building = this.state.buildings.find(b => b.id === buildingId);
                if (!building) return;
                
                this.state.activeBuildingId = buildingId;
                
                // æ›´æ–°å»ºç­‘åˆ—è¡¨ä¸­çš„æ´»åŠ¨é¡¹
                document.querySelectorAll('.building-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeItem = Array.from(document.querySelectorAll('.building-item')).find(item => {
                    return item.querySelector('.building-name').textContent === building.name;
                });
                
                if (activeItem) {
                    activeItem.classList.add('active');
                }
                
                // åˆ›å»ºè¯¦æƒ…é¢æ¿å†…å®¹
                const detailPanel = document.getElementById('building-detail');
                detailPanel.innerHTML = `
                    <div class="detail-header">
                        <h3>${building.name}</h3>
                        <button class="close-detail" id="close-detail">
                            âœ•
                        </button>
                    </div>
                    <div class="detail-content">
                        <div class="detail-row">
                            <div class="detail-label">ç±»åˆ«</div>
                            <div class="detail-value"><span class="detail-category">${building.category}</span></div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æè¿°</div>
                            <div class="detail-value">${building.description}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">åæ ‡</div>
                            <div class="detail-value">çº¬åº¦: ${building.lat.toFixed(6)}, ç»åº¦: ${building.lng.toFixed(6)}</div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">æ ‡è¯†æ ·å¼</div>
                            <div class="detail-value">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="width: 20px; height: 20px; background-color: ${building.color}; border: 1px solid rgba(0,0,0,0.1); border-radius: 50%;"></div>
                                    <div>é¢œè‰²: <span style="color: ${building.color}; font-weight: 600;">${building.color}</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="detail-row">
                            <div class="detail-label">è·¯å¾„è§„åˆ’</div>
                            <div class="detail-value">
                                <button class="category-btn" id="center-on-map" style="margin-top: 5px;">
                                    åœ¨åœ°å›¾ä¸Šå±…ä¸­
                                </button>
                                <button class="category-btn" id="set-as-start" style="margin-top: 5px; margin-left: 10px;">
                                    è®¾ä¸ºè·¯å¾„èµ·ç‚¹
                                </button>
                                <button class="category-btn" id="set-as-end" style="margin-top: 5px; margin-left: 10px;">
                                    è®¾ä¸ºè·¯å¾„ç»ˆç‚¹
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
                detailPanel.classList.add('active');
                
                // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
                document.getElementById('close-detail').addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‹–åŠ¨
                    this.hideBuildingDetail();
                    this.hideHighlightLabel();
                    this.restoreMarker();
                });
                
                // æ·»åŠ å±…ä¸­æŒ‰é’®äº‹ä»¶
                document.getElementById('center-on-map').addEventListener('click', () => {
                    this.centerMapOnBuilding(building);
                });
                
                // æ·»åŠ è®¾ä¸ºèµ·ç‚¹æŒ‰é’®äº‹ä»¶
                document.getElementById('set-as-start').addEventListener('click', () => {
                    document.getElementById('route-start').value = `${building.lng},${building.lat}`;
                    document.getElementById('navigation-panel').classList.add('active');
                    this.state.navigationVisible = true;
                    this.hideBuildingDetail();
                    this.hideHighlightLabel();
                    this.restoreMarker();
                });
                
                // æ·»åŠ è®¾ä¸ºç»ˆç‚¹æŒ‰é’®äº‹ä»¶
                document.getElementById('set-as-end').addEventListener('click', () => {
                    document.getElementById('route-end').value = `${building.lng},${building.lat}`;
                    document.getElementById('navigation-panel').classList.add('active');
                    this.state.navigationVisible = true;
                    this.hideBuildingDetail();
                    this.hideHighlightLabel();
                    this.restoreMarker();
                });
            },

            // éšè—å»ºç­‘è¯¦æƒ…
            hideBuildingDetail: function() {
                document.getElementById('building-detail').classList.remove('active');
                this.state.activeBuildingId = null;
                
                // ç§»é™¤å»ºç­‘åˆ—è¡¨ä¸­çš„æ´»åŠ¨é¡¹
                document.querySelectorAll('.building-item').forEach(item => {
                    item.classList.remove('active');
                });
            },

            // å°†åœ°å›¾å±…ä¸­åˆ°å»ºç­‘
            centerMapOnBuilding: function(building) {
                if (!this.state.map) {
                    alert('åœ°å›¾æœªåŠ è½½æˆåŠŸï¼Œæ— æ³•å®šä½åˆ°è¯¥å»ºç­‘');
                    return;
                }
                
                const point = new BMap.Point(building.lng, building.lat);
                this.state.map.centerAndZoom(point, 18);
            },

            // åˆ›å»ºå›¾ä¾‹
            createLegend: function() {
                const legend = document.getElementById('legend');
                const uniqueCategories = [...new Set(this.state.buildings.map(b => b.category))];
                
                let legendHTML = '<h4>å›¾ä¾‹è¯´æ˜</h4>';
                
                uniqueCategories.forEach(category => {
                    // è·å–è¯¥ç±»åˆ«çš„ç¬¬ä¸€ä¸ªå»ºç­‘ä½œä¸ºç¤ºä¾‹
                    const exampleBuilding = this.state.buildings.find(b => b.category === category);
                    
                    if (exampleBuilding) {
                        legendHTML += `
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: ${exampleBuilding.color};"></div>
                                <span>${category}</span>
                            </div>
                        `;
                    }
                });
                
                legendHTML += `
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #666; border-top: 1px solid #eee; padding-top: 8px;">
                        <div>ç‚¹å‡»å»ºç­‘åˆ—è¡¨æˆ–åœ°å›¾æ ‡è®°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
                        <div style="margin-top: 4px;">æ¯ä¸ªæ ‡è®°ä¸­å¿ƒçš„æ•°å­—æ˜¯å»ºç­‘ç¼–å·</div>
                    </div>
                `;
                
                legend.innerHTML = legendHTML;
            },

            // è·¯çº¿è§„åˆ’åŠŸèƒ½ï¼ˆæ”¯æŒå½“å‰ä½ç½®ï¼‰
            planRoute: function() {
                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
                document.getElementById('route-error').classList.remove('active');
                
                const startValue = document.getElementById('route-start').value;
                const endValue = document.getElementById('route-end').value;
                const mode = document.getElementById('route-mode').value;
                
                if (!startValue || !endValue) {
                    alert('è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹');
                    return;
                }
                
                // æ¸…é™¤ä¹‹å‰çš„è·¯çº¿
                this.clearRoute();
                
                // è§£æèµ·ç‚¹
                let startPoint, startName;
                if (startValue === 'current_location') {
                    if (!this.state.currentPosition) {
                        alert('è¯·å…ˆè·å–æ‚¨çš„ä½ç½®');
                        return;
                    }
                    
                    if (this.state.currentPosition.isBaiduCoord) {
                        startPoint = new BMap.Point(this.state.currentPosition.lng, this.state.currentPosition.lat);
                    } else {
                        // å¦‚æœæ˜¯WGS84åæ ‡ï¼Œéœ€è¦è½¬æ¢
                        this.convertWGS84ToBD09Accurate(
                            this.state.currentPosition.lng,
                            this.state.currentPosition.lat,
                            (baiduPoint) => {
                                this.planRouteWithPoint(baiduPoint, endValue, mode, 'æˆ‘çš„ä½ç½®');
                            }
                        );
                        return;
                    }
                    startName = 'æˆ‘çš„ä½ç½®';
                } else {
                    const [startLng, startLat] = startValue.split(',').map(Number);
                    startPoint = new BMap.Point(startLng, startLat);
                    
                    // è·å–å»ºç­‘åç§°
                    const startBuilding = this.state.buildings.find(b => 
                        Math.abs(b.lng - startLng) < 0.0001 && Math.abs(b.lat - startLat) < 0.0001
                    );
                    startName = startBuilding ? startBuilding.name : 'èµ·ç‚¹';
                }
                
                // è§£æç»ˆç‚¹
                let endPoint, endName;
                if (endValue === 'current_location') {
                    if (!this.state.currentPosition) {
                        alert('è¯·å…ˆè·å–æ‚¨çš„ä½ç½®');
                        return;
                    }
                    
                    if (this.state.currentPosition.isBaiduCoord) {
                        endPoint = new BMap.Point(this.state.currentPosition.lng, this.state.currentPosition.lat);
                    } else {
                        // å¦‚æœæ˜¯WGS84åæ ‡ï¼Œéœ€è¦è½¬æ¢
                        this.convertWGS84ToBD09Accurate(
                            this.state.currentPosition.lng,
                            this.state.currentPosition.lat,
                            (baiduPoint) => {
                                this.planRouteWithPoint(startPoint, baiduPoint, mode, startName, 'æˆ‘çš„ä½ç½®');
                            }
                        );
                        return;
                    }
                    endName = 'æˆ‘çš„ä½ç½®';
                } else {
                    const [endLng, endLat] = endValue.split(',').map(Number);
                    endPoint = new BMap.Point(endLng, endLat);
                    
                    // è·å–å»ºç­‘åç§°
                    const endBuilding = this.state.buildings.find(b => 
                        Math.abs(b.lng - endLng) < 0.0001 && Math.abs(b.lat - endLat) < 0.0001
                    );
                    endName = endBuilding ? endBuilding.name : 'ç»ˆç‚¹';
                }
                
                // ä½¿ç”¨ç™¾åº¦åœ°å›¾APIå†…ç½®çš„è·¯çº¿è§„åˆ’åŠŸèƒ½
                this.planRouteWithBaiduAPI(startPoint, endPoint, mode, startName, endName);
            },

            // ä½¿ç”¨ç™¾åº¦åœ°å›¾APIå†…ç½®çš„è·¯çº¿è§„åˆ’
            planRouteWithBaiduAPI: function(startPoint, endPoint, mode, startName, endName) {
                console.log('ä½¿ç”¨ç™¾åº¦åœ°å›¾APIè§„åˆ’è·¯çº¿...');
                
                // æ¸…é™¤ä¹‹å‰çš„è·¯çº¿
                this.clearRoute();
                
                try {
                    let routeInstance;
                    
                    if (mode === 'walking') {
                        // æ­¥è¡Œè·¯çº¿è§„åˆ’
                        routeInstance = new BMap.WalkingRoute(this.state.map, {
                            renderOptions: {
                                map: this.state.map,
                                autoViewport: true,
                                selectFirstResult: true
                            }
                        });
                        this.state.walkingRoute = routeInstance;
                    } else {
                        // é©¾è½¦è·¯çº¿è§„åˆ’
                        routeInstance = new BMap.DrivingRoute(this.state.map, {
                            renderOptions: {
                                map: this.state.map,
                                autoViewport: true,
                                selectFirstResult: true
                            },
                            policy: BMAP_DRIVING_POLICY_DEFAULT
                        });
                        this.state.drivingRoute = routeInstance;
                    }
                    
                    // æ·»åŠ è·¯çº¿è§„åˆ’å®Œæˆäº‹ä»¶ç›‘å¬
                    routeInstance.addEventListener("onSearchComplete", (result) => {
                        this.handleBaiduRouteResult(result, mode, startName, endName);
                    });
                    
                    // å¼€å§‹æœç´¢è·¯çº¿
                    routeInstance.search(startPoint, endPoint);
                    
                } catch (error) {
                    console.error('ç™¾åº¦åœ°å›¾è·¯çº¿è§„åˆ’å¤±è´¥:', error);
                    // å›é€€åˆ°ç®€åŒ–ç‰ˆ
                    this.planRouteSimple(startPoint, endPoint, mode, startName, endName);
                }
            },

            // å¤„ç†ç™¾åº¦è·¯çº¿è§„åˆ’ç»“æœ
            handleBaiduRouteResult: function(result, mode, startName, endName) {
                const resultsDiv = document.getElementById('route-results');
                
                if (!result) {
                    resultsDiv.innerHTML = '<div class="route-error active">è·¯çº¿è§„åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
                    return;
                }
                
                // è·å–è·¯çº¿æ–¹æ¡ˆ
                const plan = result.getPlan(0);
                if (!plan) {
                    resultsDiv.innerHTML = '<div class="route-error active">æœªæ‰¾åˆ°å¯ç”¨è·¯çº¿</div>';
                    return;
                }
                
                // è·å–è·ç¦»å’Œæ—¶é—´
                const distance = plan.getDistance(true);
                const time = plan.getDuration(true);
                
                // é‡ç½®å¯¼èˆªçŠ¶æ€
                this.state.routeSteps = [];
                this.state.currentStepIndex = 0;
                
                // è·å–è·¯çº¿æ­¥éª¤
                let stepsHtml = '';
                let totalDistanceMeters = 0;
                
                if (plan.getNumRoutes() > 0) {
                    const route = plan.getRoute(0);
                    const steps = route.getSteps();
                    
                    // ä¿å­˜æ­¥éª¤ä¿¡æ¯ç”¨äºå¯¼èˆª
                    this.state.routeSteps = steps;
                    
                    steps.forEach((step, index) => {
                        const stepDistance = step.getDistance(true);
                        const stepDescription = step.getDescription(true);
                        
                        // æå–è·ç¦»æ•°å€¼ï¼ˆå•ä½ï¼šç±³ï¼‰
                        let stepDistanceValue = 0;
                        if (stepDistance) {
                            const match = stepDistance.match(/[\d.]+/);
                            if (match) {
                                stepDistanceValue = parseFloat(match[0]);
                                if (stepDistance.includes('å…¬é‡Œ')) {
                                    stepDistanceValue *= 1000;
                                }
                                totalDistanceMeters += stepDistanceValue;
                            }
                        }
                        
                        stepsHtml += `
                            <div class="route-step" data-step-index="${index}">
                                <div class="step-header">
                                    <div class="step-number">${index + 1}</div>
                                    <div class="step-distance">${stepDistance || '--'}</div>
                                </div>
                                <div class="step-instruction">${stepDescription || '--'}</div>
                            </div>
                        `;
                    });
                }
                
                // è®¡ç®—æ€»è·ç¦»ï¼ˆå¦‚æœAPIæ²¡æœ‰ç›´æ¥æä¾›ï¼‰
                if (totalDistanceMeters === 0) {
                    totalDistanceMeters = this.parseDistanceToMeters(distance);
                }
                
                const html = `
                    <div class="route-summary">
                        <div class="route-summary-row">
                            <span class="summary-label">å‡ºè¡Œæ–¹å¼:</span>
                            <span class="summary-value">
                                ${mode === 'walking' ? 'æ­¥è¡Œ' : 'é©¾è½¦'}
                                <span class="mode-indicator ${mode === 'walking' ? 'mode-walking' : 'mode-driving'}">
                                    ${mode === 'walking' ? 'ğŸš¶' : 'ğŸš—'}
                                </span>
                            </span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">èµ·ç‚¹:</span>
                            <span class="summary-value">${startName}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">ç»ˆç‚¹:</span>
                            <span class="summary-value">${endName}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">æ€»è·ç¦»:</span>
                            <span class="summary-value">${distance}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">é¢„è®¡æ—¶é—´:</span>
                            <span class="summary-value">${time}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">æ€»æ­¥æ•°:</span>
                            <span class="summary-value">${plan.getNumRoutes() > 0 ? plan.getRoute(0).getSteps().length : 0} æ­¥</span>
                        </div>
                    </div>
                    <div class="route-steps">
                        <h4 style="margin-bottom: 10px; color: #1b5e20; font-size: 0.95rem;">è·¯çº¿æŒ‡å¼•</h4>
                        ${stepsHtml}
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
                
                // æ˜¾ç¤ºå¯¼èˆªæ§åˆ¶æŒ‰é’®
                if (this.state.routeSteps.length > 0) {
                    document.getElementById('route-navigation-controls').style.display = 'flex';
                    this.updateNavigationControls();
                } else {
                    document.getElementById('route-navigation-controls').style.display = 'none';
                }
                
                // é«˜äº®æ˜¾ç¤ºç¬¬ä¸€æ­¥
                this.highlightStep(0);
                
                // è°ƒæ•´åœ°å›¾è§†å›¾ä»¥æ˜¾ç¤ºæ•´ä¸ªè·¯çº¿
                this.state.map.setViewport([startPoint, endPoint]);
            },

            // é«˜äº®æ˜¾ç¤ºæŒ‡å®šæ­¥éª¤
            highlightStep: function(stepIndex) {
                // ç§»é™¤æ‰€æœ‰æ­¥éª¤çš„é«˜äº®
                document.querySelectorAll('.route-step').forEach(step => {
                    step.style.backgroundColor = 'white';
                    step.style.boxShadow = 'none';
                });
                
                // é«˜äº®å½“å‰æ­¥éª¤
                const currentStep = document.querySelector(`.route-step[data-step-index="${stepIndex}"]`);
                if (currentStep) {
                    currentStep.style.backgroundColor = '#f1f8e9';
                    currentStep.style.boxShadow = '0 2px 5px rgba(0,0,0,0.1)';
                    
                    // æ»šåŠ¨åˆ°å½“å‰æ­¥éª¤
                    currentStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
                
                // æ›´æ–°å¯¼èˆªæ§åˆ¶æŒ‰é’®çŠ¶æ€
                this.updateNavigationControls();
            },

            // æ›´æ–°å¯¼èˆªæ§åˆ¶æŒ‰é’®çŠ¶æ€
            updateNavigationControls: function() {
                const prevBtn = document.getElementById('prev-step-btn');
                const nextBtn = document.getElementById('next-step-btn');
                const indicator = document.getElementById('current-step-indicator');
                
                // æ›´æ–°æŒ‡ç¤ºå™¨
                indicator.textContent = `æ­¥éª¤ ${this.state.currentStepIndex + 1} / ${this.state.routeSteps.length}`;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                prevBtn.disabled = this.state.currentStepIndex === 0;
                nextBtn.disabled = this.state.currentStepIndex === this.state.routeSteps.length - 1;
                
                // å¦‚æœæ²¡æœ‰æ­¥éª¤ï¼Œéšè—å¯¼èˆªæ§åˆ¶
                if (this.state.routeSteps.length === 0) {
                    document.getElementById('route-navigation-controls').style.display = 'none';
                }
            },

            // å¯¼èˆªåˆ°ä¸Šä¸€æ­¥
            navigateToPrevStep: function() {
                if (this.state.currentStepIndex > 0) {
                    this.state.currentStepIndex--;
                    this.highlightStep(this.state.currentStepIndex);
                }
            },

            // å¯¼èˆªåˆ°ä¸‹ä¸€æ­¥
            navigateToNextStep: function() {
                if (this.state.currentStepIndex < this.state.routeSteps.length - 1) {
                    this.state.currentStepIndex++;
                    this.highlightStep(this.state.currentStepIndex);
                }
            },

            // è§£æè·ç¦»å­—ç¬¦ä¸²ä¸ºç±³æ•°
            parseDistanceToMeters: function(distanceStr) {
                if (!distanceStr) return 0;
                
                try {
                    const numMatch = distanceStr.match(/[\d.]+/);
                    if (!numMatch) return 0;
                    
                    const num = parseFloat(numMatch[0]);
                    
                    if (distanceStr.includes('å…¬é‡Œ')) {
                        return num * 1000;
                    } else if (distanceStr.includes('ç±³')) {
                        return num;
                    }
                } catch (e) {
                    console.error('è§£æè·ç¦»å¤±è´¥:', e);
                }
                
                return 0;
            },

            // ç®€åŒ–ç‰ˆè·¯çº¿è§„åˆ’
            planRouteSimple: function(startPoint, endPoint, mode, startName, endName) {
                console.log('ä½¿ç”¨ç®€åŒ–ç‰ˆè·¯çº¿è§„åˆ’...');
                
                // æ¸…é™¤ä¹‹å‰çš„è·¯çº¿
                this.clearRoute();
                
                // åˆ›å»ºèµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
                this.createRouteMarkers(startPoint, endPoint, startName, endName);
                
                // è®¡ç®—å¹¶ç»˜åˆ¶è·¯çº¿
                const routePoints = this.calculateSimpleRoute(startPoint, endPoint);
                this.drawRoutePolyline(routePoints, mode);
                
                // è®¡ç®—è·ç¦»å’Œä¼°ç®—æ—¶é—´
                const distance = this.calculateRouteDistance(routePoints);
                const estimatedTime = this.estimateTravelTime(distance, mode);
                
                // æ˜¾ç¤ºè·¯çº¿ä¿¡æ¯
                this.displaySimpleRouteInfo(startName, endName, distance, estimatedTime, mode);
                
                // è°ƒæ•´åœ°å›¾è§†å›¾
                this.state.map.setViewport([startPoint, endPoint]);
                
                // ç®€åŒ–ç‰ˆæ²¡æœ‰æ­¥éª¤å¯¼èˆªï¼Œéšè—å¯¼èˆªæ§åˆ¶
                document.getElementById('route-navigation-controls').style.display = 'none';
            },

            // åˆ›å»ºè·¯çº¿æ ‡è®°
            createRouteMarkers: function(startPoint, endPoint, startName, endName) {
                // åˆ›å»ºèµ·ç‚¹æ ‡è®°
                const startMarker = new BMap.Marker(startPoint, {
                    icon: new BMap.Icon('', new BMap.Size(32, 32), {
                        anchor: new BMap.Size(16, 32)
                    })
                });
                
                // åˆ›å»ºè‡ªå®šä¹‰èµ·ç‚¹å›¾æ ‡
                const startIcon = this.createRouteMarkerIcon('#4CAF50', 'S');
                startMarker.setIcon(startIcon);
                
                const startLabel = new BMap.Label(startName, {
                    offset: new BMap.Size(0, -35)
                });
                startMarker.setLabel(startLabel);
                this.state.map.addOverlay(startMarker);
                this.state.routeMarkers.push(startMarker);
                
                // åˆ›å»ºç»ˆç‚¹æ ‡è®°
                const endMarker = new BMap.Marker(endPoint, {
                    icon: new BMap.Icon('', new BMap.Size(32, 32), {
                        anchor: new BMap.Size(16, 32)
                    })
                });
                
                // åˆ›å»ºè‡ªå®šä¹‰ç»ˆç‚¹å›¾æ ‡
                const endIcon = this.createRouteMarkerIcon('#FF5722', 'E');
                endMarker.setIcon(endIcon);
                
                const endLabel = new BMap.Label(endName, {
                    offset: new BMap.Size(0, -35)
                });
                endMarker.setLabel(endLabel);
                this.state.map.addOverlay(endMarker);
                this.state.routeMarkers.push(endMarker);
            },

            // åˆ›å»ºè·¯çº¿æ ‡è®°å›¾æ ‡
            createRouteMarkerIcon: function(color, text) {
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶åœ†å½¢èƒŒæ™¯
                ctx.beginPath();
                ctx.arc(16, 16, 12, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                
                // ç»˜åˆ¶ç™½è‰²è¾¹æ¡†
                ctx.beginPath();
                ctx.arc(16, 16, 12, 0, Math.PI * 2);
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'white';
                ctx.stroke();
                
                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(text, 16, 16);
                
                // å°†Canvasè½¬æ¢ä¸ºDataURL
                const iconUrl = canvas.toDataURL('image/png');
                
                // åˆ›å»ºå›¾æ ‡
                const iconSize = new BMap.Size(32, 32);
                return new BMap.Icon(iconUrl, iconSize, {
                    anchor: new BMap.Size(16, 16)
                });
            },

            // è®¡ç®—ç®€åŒ–ç‰ˆè·¯çº¿
            calculateSimpleRoute: function(startPoint, endPoint) {
                const points = [startPoint];
                
                // è®¡ç®—ç›´çº¿è·ç¦»
                const distance = this.calculateDistance(
                    {lat: startPoint.lat, lng: startPoint.lng},
                    {lat: endPoint.lat, lng: endPoint.lng}
                );
                
                // å¦‚æœè·ç¦»è¾ƒè¿œï¼Œæ·»åŠ ä¸­é—´ç‚¹ä½¿è·¯çº¿æ›´è‡ªç„¶
                if (distance > 300) {
                    // æ·»åŠ ä¸€ä¸ªä¸­é—´ç‚¹ï¼Œç¨å¾®åç§»
                    const midPoint = new BMap.Point(
                        (startPoint.lng + endPoint.lng) / 2 + 0.0005,
                        (startPoint.lat + endPoint.lat) / 2 + 0.0005
                    );
                    points.push(midPoint);
                }
                
                points.push(endPoint);
                return points;
            },

            // ç»˜åˆ¶è·¯çº¿æŠ˜çº¿
            drawRoutePolyline: function(points, mode) {
                if (!points || points.length < 2) return;
                
                // æ ¹æ®å‡ºè¡Œæ¨¡å¼è®¾ç½®æ ·å¼
                const style = mode === 'walking' ? {
                    strokeColor: "#4CAF50",
                    strokeWeight: 4,
                    strokeOpacity: 0.8,
                    strokeStyle: "dashed"
                } : {
                    strokeColor: "#2196F3",
                    strokeWeight: 5,
                    strokeOpacity: 0.8,
                    strokeStyle: "solid"
                };
                
                // åˆ›å»ºæŠ˜çº¿
                this.state.routePolyline = new BMap.Polyline(points, style);
                
                // æ·»åŠ åˆ°åœ°å›¾
                this.state.map.addOverlay(this.state.routePolyline);
            },

            // è®¡ç®—è·¯çº¿è·ç¦»
            calculateRouteDistance: function(points) {
                let totalDistance = 0;
                
                for (let i = 0; i < points.length - 1; i++) {
                    const point1 = {lat: points[i].lat, lng: points[i].lng};
                    const point2 = {lat: points[i+1].lat, lng: points[i+1].lng};
                    totalDistance += this.calculateDistance(point1, point2);
                }
                
                return totalDistance;
            },

            // ä¼°ç®—æ—…è¡Œæ—¶é—´
            estimateTravelTime: function(distance, mode) {
                let speed; // é€Ÿåº¦ï¼ˆç±³/ç§’ï¼‰
                
                switch(mode) {
                    case 'walking':
                        speed = 1.4; // æ­¥è¡Œçº¦5å…¬é‡Œ/å°æ—¶
                        break;
                    case 'driving':
                        speed = 8.33; // é©¾è½¦çº¦30å…¬é‡Œ/å°æ—¶ï¼ˆæ ¡å›­å†…ï¼‰
                        break;
                    default:
                        speed = 1.4;
                }
                
                const seconds = distance / speed;
                return this.formatTime(seconds);
            },

            // æ ¼å¼åŒ–æ—¶é—´
            formatTime: function(seconds) {
                if (seconds < 60) {
                    return Math.round(seconds) + 'ç§’';
                } else if (seconds < 3600) {
                    const minutes = Math.round(seconds / 60);
                    return minutes + 'åˆ†é’Ÿ';
                } else {
                    const hours = Math.floor(seconds / 3600);
                    const minutes = Math.round((seconds % 3600) / 60);
                    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                }
            },

            // æ˜¾ç¤ºç®€åŒ–ç‰ˆè·¯çº¿ä¿¡æ¯
            displaySimpleRouteInfo: function(startName, endName, distance, time, mode) {
                const resultsDiv = document.getElementById('route-results');
                
                // ç”Ÿæˆè·¯çº¿æ­¥éª¤
                let stepsHtml = '';
                const steps = [
                    `ä» ${startName} å‡ºå‘`,
                    `æ²¿ç€æ ¡å›­é“è·¯${mode === 'walking' ? 'æ­¥è¡Œ' : 'é©¾è½¦'}çº¦ ${this.formatDistance(distance)}`,
                    `åˆ°è¾¾ ${endName}`
                ];
                
                steps.forEach((step, index) => {
                    stepsHtml += `
                        <div class="route-step" data-step-index="${index}">
                            <div class="step-header">
                                <div class="step-number">${index + 1}</div>
                                <div class="step-distance">${index === 1 ? this.formatDistance(distance) : '--'}</div>
                            </div>
                            <div class="step-instruction">${step}</div>
                        </div>
                    `;
                });
                
                const html = `
                    <div class="route-summary">
                        <div class="route-summary-row">
                            <span class="summary-label">å‡ºè¡Œæ–¹å¼:</span>
                            <span class="summary-value">
                                ${mode === 'walking' ? 'æ­¥è¡Œ' : 'é©¾è½¦'}
                                <span class="mode-indicator ${mode === 'walking' ? 'mode-walking' : 'mode-driving'}">
                                    ${mode === 'walking' ? 'ğŸš¶' : 'ğŸš—'}
                                </span>
                            </span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">èµ·ç‚¹:</span>
                            <span class="summary-value">${startName}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">ç»ˆç‚¹:</span>
                            <span class="summary-value">${endName}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">æ€»è·ç¦»:</span>
                            <span class="summary-value">${this.formatDistance(distance)}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">é¢„è®¡æ—¶é—´:</span>
                            <span class="summary-value">${time}</span>
                        </div>
                        <div class="route-summary-row">
                            <span class="summary-label">è·¯çº¿ç±»å‹:</span>
                            <span class="summary-value">ç®€åŒ–ç‰ˆè·¯çº¿ï¼ˆç›´çº¿è·ç¦»ï¼‰</span>
                        </div>
                    </div>
                    <div class="route-steps">
                        <h4 style="margin-bottom: 10px; color: #1b5e20; font-size: 0.95rem;">è·¯çº¿æŒ‡å¼•</h4>
                        ${stepsHtml}
                    </div>
                `;
                
                resultsDiv.innerHTML = html;
            },

            // æ¸…é™¤è·¯çº¿
            clearRoute: function() {
                // æ¸…é™¤æŠ˜çº¿
                if (this.state.routePolyline) {
                    this.state.map.removeOverlay(this.state.routePolyline);
                    this.state.routePolyline = null;
                }
                
                // æ¸…é™¤æ ‡è®°
                this.state.routeMarkers.forEach(marker => {
                    this.state.map.removeOverlay(marker);
                });
                this.state.routeMarkers = [];
                
                // æ¸…é™¤ç™¾åº¦è·¯çº¿è§„åˆ’å®ä¾‹
                if (this.state.walkingRoute) {
                    try {
                        this.state.walkingRoute.clearResults();
                    } catch (e) {
                        console.log('æ¸…é™¤æ­¥è¡Œè·¯çº¿æ—¶å‡ºé”™:', e);
                    }
                    this.state.walkingRoute = null;
                }
                
                if (this.state.drivingRoute) {
                    try {
                        this.state.drivingRoute.clearResults();
                    } catch (e) {
                        console.log('æ¸…é™¤é©¾è½¦è·¯çº¿æ—¶å‡ºé”™:', e);
                    }
                    this.state.drivingRoute = null;
                }
                
                // é‡ç½®å¯¼èˆªçŠ¶æ€
                this.state.routeSteps = [];
                this.state.currentStepIndex = 0;
                
                // æ¸…é™¤ç»“æœæ˜¾ç¤º
                document.getElementById('route-results').innerHTML = 
                    '<div class="route-no-results">è¯·é€‰æ‹©èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œç„¶åç‚¹å‡»"è§„åˆ’è·¯çº¿"æŒ‰é’®</div>';
                
                // éšè—å¯¼èˆªæ§åˆ¶
                document.getElementById('route-navigation-controls').style.display = 'none';
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åº”ç”¨
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            App.init();
        };
        
        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶ï¼Œç¡®ä¿åœ°å›¾çŠ¶æ€æ­£ç¡®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // é¡µé¢é‡æ–°å˜ä¸ºå¯è§æ—¶ï¼Œç¡®ä¿åœ°å›¾è§£é”
                setTimeout(() => {
                    App.ensureMapUnlocked();
                }, 100);
            }
        });
    </script>
</body>
</html>